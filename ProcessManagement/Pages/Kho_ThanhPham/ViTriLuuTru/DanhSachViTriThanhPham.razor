@using ProcessManagement.Commons
@using ProcessManagement.Models.KHO_TPHAM
@using ProcessManagement.Models.KHSXs
@using ProcessManagement.Pages.Kho_ThanhPham.NhapKho
@using ProcessManagement.Pages.Manager_NVL.Dialogs
@using ProcessManagement.Services.QRCodes
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject TooltipService TooltipService
@inject SQLServerServices SQLServerServices
@inject QRCodeServices QRCodeServices
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<style>
    .vitri_IsSelected {
        border-style: solid;
        border-width: 2px;
        border-color: green;
    }

    .vitriofTP_IsSelected {
        border-style: solid;
        border-width: 2px;
        border-color: green;
        padding: 2px;
    }

    .vitriofTP_UnSelected {
        padding: 2px;
        cursor: pointer;
    }

    .vtofnvl_IsSelectd {
        width: 100%;
        height: contain;
        padding: 1px;
        background-color: var(--rz-success-dark) !important;
    }

    .vtofnvl_UnSelectd {
        width: 100%;
        height: contain;
        padding: 0px;
        cursor: pointer;
    }
</style>

<RadzenStack Style="height: contain; width: 100%; padding-bottom: 5px; padding-left: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
    <RadzenRow Style="height: 100%; width: 100%;">
        <RadzenColumn SizeMD="3" Size="12">
            <RadzenStack Style="height: 100%; width: 100%; border-radius: 10px; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="QUẢN LÝ KHO THÀNH PHẨM" Style="color: green; font-weight: 600; font-size: 18px"></RadzenText>
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn SizeMD="5" Size="12">
            <RadzenStack Gap="15px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End" Style="height: 100%; width: 100%;">
                <RadzenTextBox @oninput="@((args) => GetFilterDSachViTriTPham(args?.Value?.ToString()?? string.Empty))" Placeholder="Nhập mã vị trí hoặc mã sản phẩm để tìm kiếm" Style="border-radius: 20px; padding-left: 20px; border-width: 2px; border-color: var(--rz-primary-light); width: 70% "></RadzenTextBox>
                <RadzenButton Icon="search" ButtonStyle="ButtonStyle.Primary" Style="border-radius: 20px;" />
                <RadzenButton Style="border-radius: 20px;" Icon="autorenew" Click="@( async() => {await GetFilterDSachViTriTPham(string.Empty);})" IsBusy="@isSearching" ButtonStyle="ButtonStyle.Primary" />
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn SizeMD="4" Size="12">
            <RadzenStack Gap="15px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="height: 100%; width: 100%; padding-left: 10px">
                <RadzenMenu Style="width: contain; padding: 0; margin: 0; border-radius: 10px; background-color: var(--rz-primary-lighter)">
                    <RadzenMenuItem Text="@($"Bộ lọc ( {DSachModeSearch[modeSearch]} )")" Icon="search">
                        <RadzenMenuItem Text="@DSachModeSearch[0]" Click="@( async() => { modeSearch = 0; await LoadDSachViTriLuuTru();} )" Icon="filter_alt"></RadzenMenuItem>
                        <RadzenMenuItem Text="@DSachModeSearch[1]" Click="@(() => modeSearch = 1)" Icon="filter_alt"></RadzenMenuItem>
                        <RadzenMenuItem Text="@DSachModeSearch[2]" Click="@(() => modeSearch = 2)" Icon="filter_alt"></RadzenMenuItem>
                        <RadzenMenuItem Text="@DSachModeSearch[3]" Click="@( async() => {modeSearch = 3; await GetFilterDSachViTriTPham(string.Empty);})" Icon="filter_alt"></RadzenMenuItem>
                        <RadzenMenuItem Text="@DSachModeSearch[4]" Click="@( async() => {modeSearch = 4; await GetFilterDSachViTriTPham(string.Empty);})" Icon="filter_alt"></RadzenMenuItem>
                    </RadzenMenuItem>
                </RadzenMenu>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

<RadzenRow Gap="10px" Style="height: 100%; width: 100%; border-top: var(--rz-grid-cell-border); padding: 0;">
    <RadzenColumn Size="12" SizeMD="5" Style="height: contain; width: 100%;">
        <RadzenStack Gap="0px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start" Style="height: 100%; width: 100%;">
            <RadzenStack Gap="10px" Style="height: contain; width: 100%; border-bottom: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenRow Style="height: 100%; width: 100%;">
                    <RadzenColumn SizeMD="8" Size="12">
                        <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding: 10px; padding-left: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                            <RadzenText Text="Danh sách vị trí kho thành phẩm" Style="color: darkred; font-weight: 600; font-size: 17px; height: contain; width: contain; font-style: italic;"></RadzenText>
                            <RadzenText Text="@($"( {DSVitris.Count} vị trí )")" Style="color: black; font-weight: 600; font-size: 16px; height: contain; width: contain; font-style: italic;"></RadzenText>
                        </RadzenStack>
                    </RadzenColumn>
                    <RadzenColumn SizeMD="4" Size="12">
                        <RadzenStack Style="height: 100%; width: 100%; padding-left: 10px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenButton Click="OnAddNewViTriLuuTru" Icon="add" Text="Thêm vị trí mới" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                          Style="height: contain; width: 100%; font-weight: 600; font-size: 15px;" />
                            <RadzenButton Visible="false" Click="@(async() => await AutoAddViTriLuuTru())" Icon="add" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                          Style="height: contain; width: 100%; font-size: 15px;" />
                        </RadzenStack>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
            <RadzenDataList Style="height: 100%; width: 100%" Density="Density.Default" PagerPosition="PagerPosition.Top" PageSize="9" AllowPaging="true" WrapItems="true" AllowVirtualization="false" Data="@DSVitris" TItem="ViTriTPham">
                <Template Context="vitri">
                    <RadzenCard Style="width: 250px; height: contain; padding: 0" Variant="Variant.Flat">
                        <RadzenCard class="@(IsVitriSelected(vitri))" Style="width: 100%; height: 100%; padding: 5px" Variant="Variant.Flat">
                            <RadzenStack onclick="@(async() => await OnViTriLuuTruClick(vitri))" Style="width: 100%; height: 100%; padding: 0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenCard class="rz-shadow-5" Variant="@((vitri.VTTPID.Value?.Equals(SelectedViTri.VTTPID.Value)?? false)? Variant.Outlined : Variant.Flat)" Style="height: 100%; width: 100%; padding: 10px; background-color: white">
                                    <RadzenStack Style="width: 100%; height: 100%;" Gap="10px" Orientation=Orientation.Vertical AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenStack Gap="0" Style="width: 100%; height: contain; padding-bottom: 5px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                            <RadzenStack Style="height: contain; width: contain; min-width: 30px; border-radius: 5px; background-color: var(--rz-primary-lighter); padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@((DSVitris.IndexOf(vitri) + 1).ToString())" Style="color: rgba(58,71,77); font-weight: 600; font-size: 15px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="height: contain; width: contain; border-radius: 5px; padding: 0px;" Gap="10" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                @if (vitri.SLConTrong > 0)
                                                {
                                                    <RadzenButton Text="@($"Còn trống {((vitri.SLConTrong > 0)? $"({vitri.SLConTrong})" : string.Empty)}")" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Flat"
                                                                  Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: 100%; cursor: default; font-weight: 600" />
                                                }
                                                else
                                                {
                                                    <RadzenButton Text="Đầy" Icon="block" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Outlined"
                                                                  Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: 100%; cursor: default; background-color: rgb(254,243,220); font-weight: 600" />
                                                }
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenText Text="Mã vị trí: " Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@($"{vitri.MaViTri.Value?.ToString()}")" Style="color: darkblue; font-weight: 700; font-size: 18px"></RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenText Text="Sức chứa: " Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@($"{vitri.VTSucChua.Value?.ToString()} (pcs)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenText Text="Đã dùng: " Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 50%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@($"{(int.TryParse(vitri.VTSucChua.Value?.ToString(), out int sc)? sc : 0) - vitri.SLConTrong} (pcs)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenCard>
                </Template>
            </RadzenDataList>
        </RadzenStack>
    </RadzenColumn>
    <RadzenColumn Size="12" SizeMD="7" Style="height: contain; width: 100%; padding-top: 10px; padding-left: 10px; border-left: var(--rz-grid-cell-border);">
        <RadzenRow class="rowbackground-style" Gap="10px" Style="height: 100%; width: 100%; border-radius: 10px;">
            <RadzenColumn Size="12" SizeMD="12" Style="height: 100%; width: 100%;">
                <RadzenCard class="rz-shadow-4" Variant="Variant.Filled" Style="width: 100%; height: 100%; padding: 5px; border-radius: 10px;">
                    <RadzenStack Gap="0" Style="height: 100%; width: 100%; padding: 5px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenRow Style="height: contain; width: 100%;">
                            <RadzenColumn Size="12" SizeMD="5">
                                <RadzenStack Gap="0" Style="height: contain; width: 100%; padding: 10px; padding-top: 0;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                    <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding: 10px; padding-left: 0;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenText Text="Thông tin chi tiết vị trí" Style="color: darkred; font-weight: 600; font-size: 17px; height: contain; width: contain; font-style: italic;"></RadzenText>
                                        <RadzenText Visible="@(!string.IsNullOrEmpty(SelectedViTri.VTTPID.Value?.ToString()))" Text="@($"( {SelectedViTri.MaViTri.Value?.ToString()} )")" Style="color: darkblue; font-weight: 700; font-size: 18px; height: contain; width: contain; font-style: italic;"></RadzenText>
                                        <RadzenText Visible="@(string.IsNullOrEmpty(SelectedViTri.VTTPID.Value?.ToString()))" Text="Chọn ô vị trí để hiển thị thông tin" Style="color: red; font-weight: 600; font-size: 17px; height: contain; width: contain; font-style: italic;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Visible="@(SelectedViTri.VTTPID.Value != null)" Gap="10px" Style="height: contain; width: 100%; padding: 0;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenText Text="Sức chứa: " Style="font-weight: 600; font-size: 16px"></RadzenText>
                                            <RadzenText Text="@($"{SelectedViTri.VTSucChua.Value?.ToString()} (pcs)")" Style="font-weight: 600; font-size: 16px"></RadzenText>
                                        </RadzenStack>
                                        <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenText Text="Số lượng LOT: " Style="font-weight: 600; font-size: 16px"></RadzenText>
                                            <RadzenText Text="@($"{SelectedViTri.DSachViTriofTPhams.Count()} (lot)")" Style="font-weight: 600; font-size: 16px"></RadzenText>
                                        </RadzenStack>
                                        <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">

                                            @if (SelectedViTri.SLConTrong == 0)
                                            {
                                                <RadzenButton Text="@($"Số lượng trống: {SelectedViTri.SLConTrong}")" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Text"
                                                              Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: 100%; cursor: default; background-color: rgb(254,243,220); font-weight: 600" />
                                            }
                                            else
                                            {
                                                <RadzenButton Text="@($"Số lượng trống: {SelectedViTri.SLConTrong}")" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Text"
                                                              Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: contain; cursor: default; background-color: rgb(229,245,233); font-weight: 600" />
                                            }

                                            <RadzenButton Disabled="@(CountDSVitriofTP(SelectedViTri) > 0)" Click="@(async () => await RemoveViTriLuuTru(SelectedViTri))" Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Shade="Shade.Darker" Variant="Variant.Flat"
                                                          Text="Xóa vị trí" Style="font-size: 15px; height: contain; width: contain;" />

                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Visible="@(SelectedViTri.VTTPID.Value != null)" Size="12" SizeMD="7">
                                <RadzenRow Style="height: contain; width: 100%;" Gap="10px">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenStack Gap="5px" Style="height: contain; width: 100%;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenStack Gap="20px" Style="height: contain; width: 100%; border-radius: 5px; background-color: var(--rz-secondary-lighter); padding: 5px; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                <RadzenText Text="@($"Mã vị trí: ")" Style="font-weight: 600; font-size: 16px; color: black;"></RadzenText>
                                                <RadzenStack Gap="10" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="@($"{SelectedViTri.MaViTri.Value?.ToString()}")" Style="font-weight: 600; font-size: 18px; color: darkblue;"></RadzenText>
                                                    <RadzenButton Click="@(async() => await CopyToClipboard(SelectedViTri.MaViTri.Value?.ToString()?? string.Empty))" Icon="content_copy" Style="--rz-icon-size: 18px;" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Light" />
                                                </RadzenStack>
                                            </RadzenStack>
                                            <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: contain; padding: 5px; border-radius: 0">
                                                <RadzenStack Style="height: contain; width: contain" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    @{
                                                        string qrBase64string = QRCodeServices.GenerateQRCode(SelectedViTri.MaViTri.Value?.ToString() ?? string.Empty, 100);
                                                        <img style="border-radius: 10px;" src="@($"data:image/png;base64,{qrBase64string}")" alt="QR Code">
                                                    }
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenStack>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding: 5px; padding-right: 10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenStack Gap="0" Style="height: contain; width: 100%; padding-bottom: 5px; padding-top: 5px; padding-left: 10px; border-bottom: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenStack Style="width: 70%; padding-left: 10px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                    <RadzenText Text="Vị trí kệ" Style="font-size: 16px; font-weight: 600;  height: contain; width: 100% "></RadzenText>
                                                </RadzenStack>
                                                <RadzenStack Style="width: 30%; height: 100%; padding-left: 20px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="@SelectedViTri.ViTriKe.Value?.ToString()" Style="font-size: 18px; color: darkblue; font-weight: bold; height: contain;"></RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                            <RadzenStack Gap="0" Style="height: contain; width: 100%; padding-bottom: 5px; padding-top: 5px; padding-left: 10px; border-bottom: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenStack Style="width: 70%; padding-left: 10px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                    <RadzenText Text="Vị trí hàng" Style="font-size: 16px; font-weight: 600; height: contain; width: 100% "></RadzenText>
                                                </RadzenStack>
                                                <RadzenStack Style="width: 30%; height: 100%; padding-left: 20px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="@SelectedViTri.ViTriHang.Value?.ToString()" Style="font-size: 18px; color: darkblue; font-weight: bold; height: contain;"></RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                            <RadzenStack Gap="0" Style="height: contain; width: 100%; padding-bottom: 5px; padding-top: 5px; padding-left: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenStack Style="width: 70%; padding-left: 10px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                    <RadzenText Text="Vị trí cột" Style="font-size: 16px; font-weight: 600; height: contain; width: 100% "></RadzenText>
                                                </RadzenStack>
                                                <RadzenStack Style="width: 30%; height: 100%; padding-left: 20px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="@SelectedViTri.ViTriCot.Value?.ToString()" Style="font-size: 18px; color: darkblue; font-weight: bold; height: contain;"></RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenStack>

                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenStack Visible="@(!string.IsNullOrEmpty(SelectedViTri.VTTPID.Value?.ToString()))" Style="height: 100%; width: 100%; padding: 5px; padding-top: 5px; padding-right: 0;" Gap="5px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                            <RadzenStack Gap="20px" Style="height: contain; width: 100%; padding: 5px; border-top: var(--rz-grid-cell-border); padding-top: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenStack Gap="10px" Style="height: contain; width: contain; padding-left: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Danh sách thùng thành phẩm" Style="color: black; font-weight: 600; font-size: 17px; font-style: italic"></RadzenText>
                                    <RadzenText Text="@($"( Số lượng: {SelectedViTri.DSachViTriofTPhams.Sum(vt => vt.PalletThungTPham.ThungTPhams.Count)} thùng )")" Style="color: black; font-weight: 600; font-size: 17px; font-style: italic"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="10px" Style="height: contain; width: contain; padding-left: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenButton Click="@(() => OnAddNewLotForViTriLuuTru(SelectedViTri))" Icon="add" Text="Thêm LOT cho vị trí" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Shade="Shade.Lighter"
                                                  Style="height: contain; width: 100%; font-weight: 600; font-size: 15px;" />
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenStack Style="width: 100%; height: contain; padding: 0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                <RadzenCard Variant="Variant.Flat" Style="height: contain; width: 100%; padding: 10px; border-top: var(--rz-grid-cell-border); margin-bottom: 10px; max-height: 550px; overflow-y: scroll">
                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">

                                        @if (SelectedViTri.DSachViTriofTPhams.Count > 0)
                                        {
                                            foreach (var vitriofTP in SelectedViTri.DSachViTriofTPhams)
                                            {
                                                var palletthungtp = vitriofTP.PalletThungTPham;

                                                <RadzenStack Style="width: 100%; height: 100%; padding: 0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenCard onclick="@(() => {OnVTofTPSelected(vitriofTP);})" class="@(((IsViTriofTPhamSelected(vitriofTP))? "vitriofTP_IsSelected rz-shadow-4" : "vitriofTP_UnSelected rz-shadow-4"))" Variant="Variant.Filled" Style="height: contain; width: 100%; padding: 10px;">
                                                        <RadzenStack Style="height: contain; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                            <RadzenStack Style="height: 30px; width: contain; border-radius: 5px; padding: 10px; margin-bottom: 5px; padding-left: 0px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                <RadzenButton Text="@($"{SelectedViTri.MaViTri.Value?.ToString()} - {vitriofTP.LotVitri.Value?.ToString()}")" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Shade="Shade.Lighter" Variant="Variant.Flat"
                                                                              MouseEnter="@(args => ShowToolTip(args, TooltipPosition.Bottom, "Mã vị trí/lot", 100, 1000))"
                                                                              Style="border-radius: 5px; --rz-icon-size: 18px; font-weight: 600; height: contain; min-height: 20px; width: contain; min-width: 80px" />
                                                                <RadzenButton Visible="@(palletthungtp.ThungTPhams.Any())" Text="Đã chứa thùng thành phẩm" Icon="check"
                                                                              ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Variant="Variant.Flat" Shade="Shade.Lighter" Style="border-radius: 5px; --rz-icon-size: 17px; font-size: 16px;" />
                                                                <RadzenText Visible="@(!palletthungtp.ThungTPhams.Any())" Text="Chưa có thùng thành phẩm" Style="font-size: 16px; font-weight: 500; height: contain; color: red"></RadzenText>
                                                            </RadzenStack>

                                                            <RadzenButton Visible="@(!palletthungtp.ThungTPhams.Any() && IsViTriofTPhamSelected(vitriofTP))" Click="@(async () => await RemoveViTriofTP(vitriofTP, SelectedViTri))" Icon="delete" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Shade="Shade.Darker" Variant="Variant.Flat"
                                                                          MouseEnter="@(args => ShowToolTip(args, TooltipPosition.Bottom, "Xóa LOT vị trí", 100, 1000))"
                                                                          Style="--rz-icon-size: 18px; font-weight: 600; height: contain; min-height: 20px; width: contain;" />
                                                        </RadzenStack>

                                                        <RadzenCard Visible="@(palletthungtp.ThungTPhams.Any())" Variant="Variant.Outlined" Style="height: contain; width: 100%; padding: 10px; border-width: 1px;">
                                                            <RadzenRow Style="width: 100%; height: contain" Gap="10px">
                                                                <RadzenColumn Size="12" SizeMD="5" Style="width: 100%; height: contain">
                                                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                        <RadzenStack Gap="5px" Orientation="Orientation.Horizontal" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                            <RadzenText Text="Pallet thành phẩm" Style="color: black; font-weight: 600; font-size: 17px; font-style: italic"></RadzenText>
                                                                        </RadzenStack>

                                                                        <RadzenStack Gap="50px" Orientation="Orientation.Horizontal" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                            <RadzenCard Style="width: contain; min-width: 80px; height: contain; padding: 5px; " Variant="Variant.Flat">
                                                                                <RadzenStack Gap="0" Style="width: contain; height: contain;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                                    <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                        <RadzenText Text="Số thùng" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                                    </RadzenStack>
                                                                                    <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                        <RadzenText Text="@($"{palletthungtp.ThungTPhams.Count} (thùng)")" Style="font-size: 17px; font-weight: 600; height: contain; color: darkred"></RadzenText>
                                                                                    </RadzenStack>
                                                                                </RadzenStack>
                                                                            </RadzenCard>
                                                                            <RadzenStack Gap="0" Style="width: contain; height: contain;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                                <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                    <RadzenText Text="Tổng số lượng" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                                </RadzenStack>
                                                                                <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                    <RadzenText Text="@($"{palletthungtp.Total} (pcs)")" Style="font-size: 17px; font-weight: 600; height: contain; color: darkred"></RadzenText>
                                                                                </RadzenStack>
                                                                            </RadzenStack>
                                                                        </RadzenStack>

                                                                        <RadzenStack Gap="10px" Orientation="Orientation.Horizontal" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                            <RadzenText Text="@($"Sản phẩm: ")" Style="font-weight: 500; font-size: 16px;"></RadzenText>
                                                                            <RadzenText Text="@($"{palletthungtp.MaSanPham}")" Style="font-weight: 600; color: black; font-size: 16px;"></RadzenText>
                                                                        </RadzenStack>

                                                                        <RadzenStack Gap="10px" Orientation="Orientation.Horizontal" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                            @{
                                                                                DateTime? ngaynk = DateTime.TryParse(palletthungtp.ThungTPhams.FirstOrDefault()?.NgayNhapKho.Value?.ToString(), out DateTime nnk) ? nnk : null;

                                                                                string _ngaynk = ngaynk?.ToString("dd/MM/yyyy") ?? "---";
                                                                            }
                                                                            <RadzenText Text="@($"Ngày nhập kho: ")" Style="font-weight: 500; font-size: 16px;"></RadzenText>
                                                                            <RadzenText Text="@($"{_ngaynk}")" Style="font-weight: 600; color: black; font-size: 16px;"></RadzenText>
                                                                        </RadzenStack>

                                                                        <RadzenStack Gap="5px" Style="width: 100%; height: contain;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                            <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                                <RadzenText Text="Mã pallet" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                            </RadzenStack>
                                                                            <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                                <RadzenButton Text="@($"{palletthungtp.PalletKey}")"
                                                                                              Click="@(() => OnOpenQR_ImageDialog(palletthungtp.PalletKey, "Mã quản lý pallet"))" Icon="qr_code"
                                                                                              Variant="Variant.Flat" Size="ButtonSize.Small" Shade="Shade.Lighter"
                                                                                              Style="font-size: 16px; font-weight: 600; height: contain; color: darkgreen"></RadzenButton>
                                                                            </RadzenStack>
                                                                        </RadzenStack>
                                                                    </RadzenStack>
                                                                </RadzenColumn>
                                                                <RadzenColumn Size="12" SizeMD="7" Style="width: 100%; height: contain">
                                                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                        <RadzenStack Gap="10px" Style="height: contain; width: contain; padding-left: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenText Text="Danh sách mã quản lý thùng" Style="color: black; font-weight: 600; font-size: 15px; font-style: italic"></RadzenText>
                                                                        </RadzenStack>
                                                                        <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; max-height: 200px; width: 100%; padding-right: 0px; overflow-y: scroll" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                            @foreach (var thung in palletthungtp.ThungTPhams)
                                                                            {
                                                                                <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 5px; padding-right: 0px; background-color: white">
                                                                                    <RadzenStack Style="width: 100%; height: 100%" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                        <RadzenStack Style="width: 70%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                            <RadzenText Text="@thung.MaQuanLyThung.Value?.ToString()" Style="color: darkblue; font-weight: 600; font-size: 14px"></RadzenText>
                                                                                        </RadzenStack>
                                                                                        <RadzenStack Gap="10px" Style="width: 30%; height: contain; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                            <RadzenText Text="@($"{thung.SoLuong.Value?.ToString()} PCS")" Style="font-size: 14px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                                        </RadzenStack>
                                                                                    </RadzenStack>
                                                                                </RadzenCard>
                                                                            }
                                                                        </RadzenStack>
                                                                    </RadzenStack>
                                                                </RadzenColumn>
                                                            </RadzenRow>
                                                        </RadzenCard>
                                                    </RadzenCard>
                                                </RadzenStack>
                                            }
                                        }
                                        else
                                        {
                                            <RadzenStack Style="width: 100%; height: contain; " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Chưa tạo LOT lưu trữ tại vị trí này" Style="font-size: 16px; font-weight: 500; height: contain; color: red"></RadzenText>
                                            </RadzenStack>
                                        }
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>
                        </RadzenStack>

                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </RadzenColumn>
</RadzenRow>

@code {
    private List<ViTriTPham> DSVitris = new();

    private ViTriTPham SelectedViTri = new();

    private ViTriofTPham SelectedViTriofTP = new();

    private Dictionary<int, string> DSachModeSearch = new() { { 0, "Tất cả vị trí" }, { 1, "Mã vị trí" }, { 2, "Tên thành phẩm" }, { 3, "Vị trí đầy" }, { 4, "Vị trí còn trống" } };
    private int modeSearch = 0;

    protected override async Task OnInitializedAsync()
    {
        // Load dsvitri
        await LoadDSachViTriLuuTru();

        SelectedViTri = DSVitris.FirstOrDefault() ?? new();

        await base.OnInitializedAsync();
    }

    // Load danh sach vi tri trong kho luu tru
    private async Task LoadDSachViTriLuuTru(object? vtid = null)
    {
        // Load the list of storage locations
        DSVitris = await Task.Run(() =>
        {
            return SQLServerServices.GetListViTriTPhams(new Dictionary<string, object?>(), true).viTriTPhams;
        });

        // Create a list to hold the tasks
        var tasks = new List<Task>();

        foreach (var vitri in DSVitris)
        {
            tasks.Add(Task.Run(async () =>
            {
                Dictionary<string, object?> parameters = new() { { ViTriofTPham.DBName.VTTPID, vitri.VTTPID.Value } };

                vitri.DSachViTriofTPhams = SQLServerServices.GetListViTriofTPhams(parameters, false).viTriofTPhams;

                vitri.DSachViTriofTPhams = RangeIncreaseLOTs(vitri.DSachViTriofTPhams);

                // Load product information
                await LoadDSachViTriofTPhams(vitri);
            }));
        }

        // Wait for all tasks to complete
        await Task.WhenAll(tasks);
    }

    private async Task LoadDSachViTriofTPhams(ViTriTPham vitri)
    {
        await Task.Run(() =>
        {
            Dictionary<string, object?> parameters = new() { { ViTriofTPham.DBName.VTTPID, vitri.VTTPID.Value } };

            vitri.DSachViTriofTPhams = SQLServerServices.GetListViTriofTPhams(parameters, false).viTriofTPhams;

            vitri.DSachViTriofTPhams = RangeIncreaseLOTs(vitri.DSachViTriofTPhams);
        });

        // Create a list to hold the tasks
        var tasks = new List<Task>();

        foreach (var vitrioftp in vitri.DSachViTriofTPhams)
        {
            tasks.Add(Task.Run(async () =>
            {
                var results = await LoadDSachPalletThungTPs(null, vitrioftp.VTofTPID.Value);

                if (results.Any())
                {
                    vitrioftp.PalletThungTPham = results.FirstOrDefault() ?? new();
                }
            }));
        }

        // Wait for all tasks to complete
        await Task.WhenAll(tasks);

        _ = int.TryParse(vitri.VTSucChua.Value?.ToString(), out int succhua) ? succhua : 0;

        vitri.SLConTrong = succhua - vitri.DSachViTriofTPhams.Where(vt => vt.PalletThungTPham.Total > 0).Sum(vt => vt.PalletThungTPham.Total);
    }

    private List<ViTriofTPham> RangeIncreaseLOTs(List<ViTriofTPham> inputList)
    {
        // Sort the list based on extracting the numeric part of the Lot property
        return inputList.OrderBy(item =>
        int.TryParse(
            item.LotVitri.Value?.ToString()?.Replace("LOT", ""),
            out int lotNumber
        ) ? lotNumber : int.MaxValue
        ).ToList();
    }

    private async Task<List<PalletThungTPham>> LoadDSachPalletThungTPs(object? khsxid, object? vtofttpID)
    {
        return await Task.Run(() =>
        {
            List<PalletThungTPham> palletThungTPhams = new();

            List<ThungTPham> thungTPhams = SQLServerServices.GetListThungTPs(new Dictionary<string, object?>() { { ThungTPham.DBName.VTofTPID, vtofttpID } }).thungTPhams;

            // Group the ThungTPham objects by IDThung
            var groupedResults = thungTPhams.Where(ttp => ttp.PalletKey.Value != null)
                                            .GroupBy(ttp => ttp.PalletKey.Value)
                                            .Select(group => new PalletThungTPham
                                                {
                                                    PalletKey = group.Key?.ToString() ?? string.Empty,
                                                    MaSanPham = SQLServerServices.GetMaSanphamByID(group.ToList().FirstOrDefault()?.SPID.Value),
                                                    Total = group.ToList().Sum(ttp => int.TryParse(ttp.SoLuong.Value?.ToString(), out int sl) ? sl : 0),
                                                    ThungTPhams = group.ToList()
                                                }).ToList();

            if (groupedResults.Any())
            {
                foreach (var pallet in groupedResults)
                {
                    foreach (var ttp in pallet.ThungTPhams)
                    {
                        if (int.TryParse(ttp.VTofTPID.Value?.ToString(), out int vtid))
                        {
                            pallet.DaNhapKho = vtid > 0;
                        }
                    }
                }

                palletThungTPhams = groupedResults;
            }

            return palletThungTPhams;
        });
    }

    private bool isSearching = false;
    private async Task GetFilterDSachViTriTPham(string keyWord)
    {
        if (isSearching == false)
        {
            isSearching = true;

            await LoadDSachViTriLuuTru();

            if (modeSearch == 1) // tim theo mavitri
            {
                DSVitris = DSVitris.Where(vitri => vitri.MaViTri.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0).ToList();
            }
            else if (modeSearch == 2) // tim theo ten
            {
                DSVitris = DSVitris.Where(vitri => vitri.DSachViTriofTPhams.Any(tp => tp.TargetSanPham.SP_MaSP.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0)).ToList();
            }
            else if (modeSearch == 3) // vi tri day
            {
                DSVitris = DSVitris.Where(vitri => vitri.SLConTrong == 0).ToList();

                if (!string.IsNullOrEmpty(keyWord.Trim()))
                {
                    DSVitris = DSVitris.Where(vitri => vitri.MaViTri.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0
                                                    || vitri.DSachViTriofTPhams.Any(tp => tp.TargetSanPham.SP_MaSP.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0)).ToList();
                }
            }
            else if (modeSearch == 4) // vi tri con trong
            {
                DSVitris = DSVitris.Where(vitri => vitri.SLConTrong > 0).ToList();

                if (!string.IsNullOrEmpty(keyWord.Trim()))
                {
                    DSVitris = DSVitris.Where(vitri => vitri.MaViTri.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0
                                                    || vitri.DSachViTriofTPhams.Any(tp => tp.TargetSanPham.SP_MaSP.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0)).ToList();
                }
            }
            else
            {
                if (!string.IsNullOrEmpty(keyWord.Trim()))
                {
                    DSVitris = DSVitris.Where(vitri => vitri.MaViTri.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0
                                                    || vitri.DSachViTriofTPhams.Any(tp => tp.TargetSanPham.SP_MaSP.Value?.ToString()?.IndexOf(keyWord.Trim(), StringComparison.OrdinalIgnoreCase) >= 0)).ToList();
                }
            }

            if (DSVitris.Count > 0)
            {
                SelectedViTri = DSVitris.FirstOrDefault() ?? new();
            }
            else SelectedViTri = new();

            isSearching = false;
        }
    }

    private async Task OnAddNewViTriLuuTru()
    {
        ViTriTPham newVitri = await DialogService.OpenAsync<DialogAddNewViTriTPham>(null, new Dictionary<string, object>() { { "DSVitris", DSVitris ?? new() } },
        new DialogOptions() { ShowTitle = true, Width = "50%", Height = "95%", Resizable = true, Draggable = true, ShowClose = false, Style = "background-color: while; border-radius: 0px; padding: 0px" });

        if (newVitri != null)
        {
            // Load dsvitri
            await LoadDSachViTriLuuTru();

            SelectedViTri = DSVitris?.FirstOrDefault(vt => vt.VTTPID.Value?.ToString() == newVitri.VTTPID.Value?.ToString()) ?? new();
        }
    }

    private void OnViTriofTPClick(ViTriofTPham selectedViTri)
    {
        SelectedViTriofTP = selectedViTri;

        StateHasChanged();
    }

    private async Task OnAddNewLotForViTriLuuTru(ViTriTPham selectedViTri)
    {
        await Task.Run(async () =>
        {
            var dsachLots = SQLServerServices.GetListViTriofTPhams(new() { { ViTriTPham.DBName.VTTPID, selectedViTri.VTTPID.Value } }, false).viTriofTPhams;

            var listLotIndexs = dsachLots.Select(lot => int.Parse(lot.LotVitri.Value?.ToString()?.Replace("LOT", "") ?? "-1"));

            int maxIndex = (listLotIndexs.Count() > 0) ? listLotIndexs.Max() : 0;

            int newIndex = -1;

            for (int i = 1; i < maxIndex; i++)
            {
                if (!listLotIndexs.Contains(i))
                {
                    newIndex = i;
                    break;
                }
            }

            if (newIndex == -1)
            {
                newIndex = maxIndex + 1;
            }

            if (newIndex != -1)
            {
                ViTriofTPham newviTriofTP = new()
                    {
                        VTTPID = { Value = selectedViTri.VTTPID.Value },
                        VTTPSoLuong = { Value = 0 },
                        LotVitri = { Value = $"LOT{newIndex}" },
                    };

                (int newvitriID, string error) = SQLServerServices.InsertViTriofTPham(newviTriofTP);

                if (newvitriID == -1)
                {

                }
                else
                {
                    // Reload danh sach vitriofTpham cua vitri
                    await LoadDSachViTriofTPhams(selectedViTri);
                }
            }
        });
    }

    private async Task AutoAddViTriLuuTru()
    {
        int maxke = 10;
        int maxhang = 3;
        int maxcot = 5;
        int maxlot = 10;
        int succhua = 100000;

        for (int i = 1; i <= maxke; i++)
        {
            for (int j = 1; j <= maxhang; j++)
            {
                for (int k = 1; k <= maxcot; k++)
                {
                    ViTriTPham vitriLuuTru = new()
                        {
                            MaViTri = { Value = $"#{i}#{j}#{k}" },
                            VTSucChua = { Value = succhua },
                            ViTriKe = { Value = i },
                            ViTriHang = { Value = j },
                            ViTriCot = { Value = k }
                        };

                    (int newvtid, string err) = SQLServerServices.InsertViTriTPham(vitriLuuTru);

                    if (newvtid > 0)
                    {
                        vitriLuuTru.VTTPID.Value = newvtid;

                        for (int l = 0; l < maxlot; l++)
                        {
                            await OnAddNewLotForViTriLuuTru(vitriLuuTru);
                        }
                    }
                    else
                    {

                    }
                }
            }
        }
    }

    private async Task OnViTriLuuTruClick(ViTriTPham selectVitri)
    {
        SelectedViTri = selectVitri;

        await Task.Delay(1);

        StateHasChanged();
    }

    private string IsVitriSelected(ViTriTPham selectVitri)
    {
        if (SelectedViTri.VTTPID.Value != null && SelectedViTri.VTTPID.Value.Equals(selectVitri.VTTPID.Value))
        {
            return "vtofnvl_IsSelectd";
        }
        else return string.Empty;
    }

    private bool IsViTriofTPhamSelected(ViTriofTPham selected)
    {
        if (SelectedViTriofTP.VTTPID.Value != selected.VTTPID.Value)
        {
            return false;
        }
        if (SelectedViTriofTP.LotVitri.Value?.ToString()?.Trim() != selected.LotVitri.Value?.ToString()?.Trim())
        {
            return false;
        }

        return true;
    }

    private void OnVTofTPSelected(ViTriofTPham selected)
    {
        if (object.Equals(selected.VTofTPID.Value, SelectedViTriofTP.VTofTPID.Value))
        {
            SelectedViTriofTP = new();
        }
        else
        {
            SelectedViTriofTP = selected;
        }

        StateHasChanged();
    }

    private int CountDSVitriofTP(ViTriTPham viTriLuuTru)
    {
        int count = viTriLuuTru.DSachViTriofTPhams.Where(vt => vt.PalletThungTPham.Total > 0).ToList().Count();

        return count;
    }

    private async Task RemoveViTriLuuTru(ViTriTPham selectedViTri)
    {
        bool? confirm = await DialogService.Confirm("Xóa vị trí này?", "Xác nhận", new ConfirmOptions() { OkButtonText = "OK", CancelButtonText = "Hủy", ShowClose = false });

        if (confirm.Value)
        {
            await Task.Run(() =>
            {
                (bool deleted, string error) = SQLServerServices.DeleteViTriTPham(selectedViTri.VTTPID.Value);

                if (deleted == false)
                {
                    ShowNotification($"Error: {error}!", NotificationSeverity.Error, 2000);
                }
                else
                {
                    ShowNotification("Removed!", NotificationSeverity.Success, 2000);
                }
            });

            await LoadDSachViTriLuuTru();

            SelectedViTri = DSVitris?.FirstOrDefault(vt => vt.VTTPID.Value?.ToString() == selectedViTri.VTTPID.Value?.ToString()) ?? new();
        }
    }

    private async Task RemoveViTriofTP(ViTriofTPham removeViTriofTP, ViTriTPham selectedViTri) // Delete LOT
    {
        bool? confirm = await DialogService.Confirm($"Xóa <strong>{removeViTriofTP.LotVitri.Value}</strong> khỏi vị trí <strong>{selectedViTri.MaViTri.Value}</strong>?", "Xác nhận", new ConfirmOptions() { OkButtonText = "OK", CancelButtonText = "Hủy", ShowClose = false });

        if (confirm.Value)
        {
            (bool removeStatus, string error) = SQLServerServices.DeleteViTriofTPham(removeViTriofTP.VTofTPID.Value);

            if (!removeStatus)
            {
                ShowNotification($"Error: {error}!", NotificationSeverity.Error, 2000);
            }
            else
            {
                await LoadDSachViTriofTPhams(selectedViTri);

                ShowNotification("Removed!", NotificationSeverity.Success, 2000);
            }
        }
    }

    private async Task CopyToClipboard(string content)
    {
        try
        {
            // Try modern Clipboard API first
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", content);

            NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Copied!",
                    Detail = $"{content}",
                    Duration = 4000
                });
        }
        catch (JSException)
        {
            try
            {
                // Fallback method
                await JSRuntime.InvokeVoidAsync("fallbackCopyToClipboard", content);

                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "Fallback Copied!",
                        Detail = $"{content}",
                        Duration = 4000
                    });
            }
            catch (Exception)
            {
                NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Error",
                        Detail = "Failed to copy text",
                        Duration = 3000
                    });
            }
        }
    }

    // Notification
    void ShowNotification(string message, NotificationSeverity notifytype, double time)
    {
        NotificationMessage notify = new NotificationMessage
            {
                Style = "position: fixed; top: 0; right: 0;",
                Severity = notifytype,
                Summary = message,
                Duration = time
            };

        NotificationService.Notify(notify);
    }

    // Tooltip
    void ShowToolTip(ElementReference elementReference, TooltipPosition position, string content, int delay, int duration = 500)
    {
        TooltipOptions options = new TooltipOptions() { Position = position, Delay = delay, Duration = duration, Style = "background-color: black" };

        TooltipService.Open(elementReference, content, options);
    }

    // Open QRIDLOT Image dialog
    private async Task OnOpenQR_ImageDialog(object content, string header)
    {
        await DialogService.OpenAsync<DialogQR_Image>(null, new Dictionary<string, object>() { { "CONTENT", content }, { "HEADER", header } },
        new DialogOptions() { CloseDialogOnEsc = true, CloseDialogOnOverlayClick = true, ShowTitle = true, Width = "contain", Height = "contain", Resizable = true, Draggable = true, ShowClose = true, Style = "background-color: while; border-radius: 10px; padding: 0px;" });
    }
}
