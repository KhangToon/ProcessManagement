@using ProcessManagement.Commons
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject SQLServerServices SQLServerServices

<RadzenCard Variant="Variant.Filled" Style="height: 100%; width: 100%; background-color: white; border-radius: 0px">
    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 100%; width: 100%;">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 5%; width: 100%;">
            <RadzenText Text="@($"Danh sách nguyên vật liệu sản phẩm")" Style="font-size: 18px; font-weight: 500; color: black"></RadzenText>
            <RadzenText Text="@($"{DanhSachNVLs?.FirstOrDefault()?.MaSP.Value?.ToString()}")" Style="font-size: 18px; font-weight: 600; color: darkblue"></RadzenText>
        </RadzenStack>
        <RadzenCard Visible="@(DisplayMode == Common.DispMode3)" Variant="Variant.Filled" Style="height: contain; width: 100%; padding: 5px;">
            <RadzenStack Style="height: 100%; width: 100%; padding: 10px;" Gap="30px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                <RadzenStack Gap="15px" Style="width: contain; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                    <RadzenStack Style="width: contain; height: 100%; padding-left: 20px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                        <RadzenText Text="Nhập số lượng sản xuất" Style="font-size: 16px; color: darkred; font-weight: 600;"></RadzenText>
                    </RadzenStack>
                    <RadzenStack Style="width: contain; height: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                        <RadzenNumeric Disabled="@(!ChooseNVL)" Placeholder="*Nhập số lượng sản xuất" TValue="int" Min="0" Max="100000"
                                       @bind-Value="@(SLsanxuat)" TextAlign="TextAlign.Center" ShowUpDown="false"
                                       Style="font-size: 14px; height: 30px; border-radius: 0; border-width: 1px; width: 100%" />
                    </RadzenStack>
                    <RadzenStack Style="width: contain; height: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                        <RadzenButton Disabled="@(SLsanxuat == 0 && !ChooseNVL)" Style="@((ChooseNVL)? "width: contain;" : "width: contain; background-color: Highlight;")"
                                      Icon="@((ChooseNVL)? "check" : "autorenew")"
                                      Click=@(() => OnTakeDanhSachNVL()) Text="@((ChooseNVL)? "Xác nhận" : "Nhập lại")" Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Success" Shade="Shade.Light" Variant="Variant.Flat"></RadzenButton>
                    </RadzenStack>
                </RadzenStack>
                <RadzenStack Visible="@(!ChooseNVL)" Gap="15px" Style="width: contain; height: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                    <RadzenText Text="Danh sách nguyên liệu đã chọn:" Style="font-size: 16px; color: black; font-weight: 600;"></RadzenText>
                    <RadzenText Text="@DanhSachNVLs?.FirstOrDefault()?.MaQuanLy.Value?.ToString()" Style="font-size: 16px; color: darkgreen; font-weight: 600;"></RadzenText>
                    <RadzenText Text="--->" Style="font-size: 14px; color: black; font-weight: 600;"></RadzenText>
                    <RadzenText Text="@DanhSachNVLs?.LastOrDefault()?.MaQuanLy.Value?.ToString()" Style="font-size: 16px; color: darkgreen; font-weight: 600;"></RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
        <RadzenCard Variant="Variant.Outlined" Style="height: 75%; width: 100%; background-color: white; border-radius: 5px;">
            <RadzenStack Style="height: 100%; width: 100%; overflow-y: scroll" Gap="10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                @if (DanhSachNVLs != null)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="background-color: rgba(58, 71, 77); padding-top: 10px; padding-bottom: 10px; height: contain; width: 100%; border-bottom: var(--rz-grid-cell-border);">
                        <RadzenStack Style="width: 5%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="STT" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.LoaiNL" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.MaSP" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.MaQuanLy" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.LotNVL" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.SoLuong" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.NgayNhap" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.NgayXuat" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.SoLuongXuat" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenText Text="@Common.GhiChu" Style="font-size: 14px; color: white; font-weight: 500;"></RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    @foreach (var nvl in DanhSachNVLs)
                    {
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: contain; width: 100%; border-bottom: var(--rz-grid-cell-border);">
                            <RadzenStack Style="width: 5%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@((DanhSachNVLs.IndexOf(nvl) + 1).ToString())" Style="color: darkgray; font-size: 12px; font-weight: 500;"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.LoaiNVL.Value?.ToString()" Style="font-size: 14px; font-weight: 600; color: darkred"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.MaSP.Value?.ToString()" Style="font-size: 14px; font-weight: 600; color: black"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.MaQuanLy.Value?.ToString()" Style="font-size: 14px;color: darkblue; font-weight: 600;"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.LotNVL.Value?.ToString()" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@($"{nvl.SoLuong.Value?.ToString()}  (pcs)")" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                @if (nvl.NgayNhap.Value?.ToString() != string.Empty)
                                {
                                    DateTime ngaynhap = Convert.ToDateTime(nvl.NgayNhap.Value?.ToString());

                                    <RadzenText Text="@ngaynhap.ToString("dd-MM-yyyy")" Style="font-size: 14px; font-weight: 500;"></RadzenText>
                                }
                            </RadzenStack>
                            <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                @if (nvl.NgayXuat.Value?.ToString() != string.Empty)
                                {
                                    DateTime ngayxuat = Convert.ToDateTime(nvl.NgayXuat.Value?.ToString());
                                    <RadzenText Text="@ngayxuat.ToString("dd-MM-yyyy")" Style="font-size: 14px; font-weight: 500;"></RadzenText>
                                }
                            </RadzenStack>
                            <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.SoLuongXuat.Value?.ToString()" Style="font-size: 14px; font-weight: 500;"></RadzenText>
                            </RadzenStack>
                            <RadzenStack Visible="@(DisplayMode != Common.DispMode3)" Style="width: 10%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="@nvl.GhiChu.Value?.ToString()" Style="font-size: 14px; font-weight: 500;"></RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    }
                }
            </RadzenStack>
        </RadzenCard>
        <RadzenStack Style="height: 5%; width: 100%; padding: 5px; padding-right: 10px; padding-top: 15px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Gap="20px" Style="height: 100%; width: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="@("Tổng: " + DanhSachNVLs?.Count)"
                            Style="font-weight: 500; font-size: 18px; color: black; "></RadzenText>
                <RadzenText Text="@($"Tổng số lượng: {DanhSachNVLs?.Sum(nvl => int.Parse(nvl.SoLuong.Value?.ToString()?? "0"))} (pcs)")"
                            Style="font-weight: 500; font-size: 18px; color: black; "></RadzenText>
            </RadzenStack>
            <RadzenButton Visible=@(DanhSachNVLs?.Count == 0 && DisplayMode == Common.DispMode2) Style="width: contain; background-color: Highlight" Icon="add"
                          Click=@(() => OnOpenDialogAddNguyenvatlieu()) Text="Thêm nguyên vật liệu" Size="ButtonSize.Small"
                          ButtonStyle="ButtonStyle.Success" Shade="Shade.Light" Variant="Variant.Flat">
            </RadzenButton>

            <RadzenStack Gap="15px" Style="height: 100%; width: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenButton Visible="@(!ChooseNVL && SLsanxuat != 0)" Style="border-radius: 4px;" Icon="save" Text="Xác nhận và thoát" Click="@(() => DialogService.Close(DanhSachNVLs))"
                              ButtonStyle="ButtonStyle.Success" Shade="Shade.Light" Variant="Variant.Filled" Size="ButtonSize.Small">
                </RadzenButton>
                <RadzenButton Style="border-radius: 4px; background-color: darkred" Icon="close" Text="Hủy" Click="@(() => DialogService.Close())"
                              Shade="Shade.Dark" Variant="Variant.Filled" Size="ButtonSize.Small">
                </RadzenButton>
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>
</RadzenCard>

@code {

    [Parameter]
    public List<NVL>? DanhSachNVLs { get; set; }
    private List<NVL>? TempDanhSachNVLs;

    [Parameter]
    public int DisplayMode { get; set; } = Common.DispMode1;

    [Parameter]
    public SanPham? TargetSP { get; set; }

    private int SLsanxuat;
    private bool ChooseNVL = true;

    protected async override Task OnInitializedAsync()
    {
        TempDanhSachNVLs = DanhSachNVLs;

        await base.OnInitializedAsync();
    }

    private async Task OnOpenDialogAddNguyenvatlieu()
    {
        await DialogService.OpenAsync<DialogAddNewNVL>(null, new Dictionary<string, object>() { { "Masanpham", TargetSP?.MaSP?.Value?.ToString() ?? string.Empty } },
        new DialogOptions() { Width = "80%", Height = "90%", Resizable = false, Draggable = false, ShowTitle = false, ShowClose = false, Style = "background-color: while; border-radius: 0px; padding: 0px" });
    }

    private void OnTakeDanhSachNVL()
    {
        if (SLsanxuat > 0)
        {
            if (ChooseNVL)
            {
                if (SLsanxuat > DanhSachNVLs?.Count)
                {
                    return;
                }
                else
                {
                    DanhSachNVLs = DanhSachNVLs?.Take(SLsanxuat).ToList();
                }

                ChooseNVL = false;
            }
            else
            {
                DanhSachNVLs = TempDanhSachNVLs;

                ChooseNVL = true;
            }
        }
    }
}
