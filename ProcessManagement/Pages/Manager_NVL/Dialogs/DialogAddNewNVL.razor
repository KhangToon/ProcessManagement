@using ProcessManagement.Commons
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject SQLServerServices SQLServerServices

<RadzenStack Gap="0" Style="width: 100%; height: 100%; background-color: white" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
    <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 95%; border-radius: 10px; padding-right: 0px;">
        <RadzenRow Style="width: 100%; height: 100%;">
            <RadzenColumn Size="12" SizeMD="4" Style="width: 100%; height: 100%">
                <RadzenStack Style="height: 100%; width: 100%; padding-right: 15px; border-right: var(--rz-grid-cell-border)" Gap="10px" Orientation="Orientation.Vertical">
                    <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 10px; background-color: white; border-radius: 10px;">
                        <RadzenStack Gap="10px" Style="width: 100%; height: 100%; padding: 10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenStack Style="width: 100%; height: contain; border-bottom: var(--rz-grid-cell-border); padding-bottom: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                <RadzenText Style="color: darkred; font-weight: 600; font-size: 16px; font-style: initial" Text="Nhập thông tin lot nguyên vật liệu"></RadzenText>
                            </RadzenStack>
                            <!------>
                            <!--Loại NL-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Loại nguyên liệu" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenTextBox @bind-Value="@autoAddNVL.LoaiNL" Placeholder="*Nhập loại nguyên liệu" Style="font-size: 14px; width: 100%; height: contain; border-radius: 5px; border-width: 1px;"></RadzenTextBox>
                                </RadzenStack>
                            </RadzenStack>
                            <!--Mã SP-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Mã sản phẩm" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenTextBox @bind-Value="@autoAddNVL.MaSP" Placeholder="*Nhập mã sản phẩm" Style="font-size: 14px; width: 100%; height: contain; border-radius: 5px; border-width: 1px;"></RadzenTextBox>
                                </RadzenStack>
                            </RadzenStack>
                            <!------>
                            <!--Chọn lot theo ngày nhập-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Ngày nhập" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenDatePicker Placeholder="*Ngày nhập" TValue="DateTime"
                                                      ValueChanged="@((args) => { autoAddNVL.LotNL = args.ToString("yyyyMMdd"); autoAddNVL.NgayNhap = args; })"
                                                      ShowTime="false" HourFormat="12" DateFormat="@Common.DayTimeFormatnoTime" AllowInput="false"
                                                      Name="DatePicker" Style="width: 100%; border-radius: 10px; font-size: 14px">
                                        @* <FooterTemplate>
                                            <RadzenStack Style="padding: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenButton Style="height: 100%; width: 50%;" Text="Today" Click="@(() => { autoAddNVL.LotNL = DateTime.Now.ToString("yyyyMMdd"); autoAddNVL.NgayNhap = DateTime.Now; })" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                                            </RadzenStack>
                                        </FooterTemplate> *@
                                    </RadzenDatePicker>
                                </RadzenStack>
                            </RadzenStack>
                            <!--Lot NL-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Lot nguyên liệu" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenTextBox @bind-Value="@autoAddNVL.LotNL" Placeholder="*Nhập lot nguyên liệu" Style="font-size: 14px; width: 100%; height: contain; border-radius: 5px; border-width: 1px;"></RadzenTextBox>
                                </RadzenStack>
                            </RadzenStack>
                            <!------>
                            <!--Số lượng-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Số lượng (pcs)" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenNumeric Placeholder="*Nhập số lượng mỗi thùng (pcs)" TValue="int" Min="0" Max="100000"
                                                   @bind-Value="@autoAddNVL.SoluongMoithung"
                                                   Style="font-size: 14px; height: contain; border-radius: 0; border-width: 1px; width: 100%" />
                                </RadzenStack>
                            </RadzenStack>
                            <!--Số thùng-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 30%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="SL thùng" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 70%; height: contain;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenNumeric Placeholder="*Nhập số lượng thùng" TValue="int" Min="0" Max="100000"
                                                   @bind-Value="@autoAddNVL.SoThung"
                                                   Style="font-size: 14px; height: contain; border-radius: 0; border-width: 1px; width: 100%" />
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>

                    <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 10px; background-color: white; border-radius: 10px;">
                        <RadzenStack Gap="10px" Style="width: 100%; height: 100%; padding: 10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenStack Style="width: 100%; height: contain; border-bottom: var(--rz-grid-cell-border); padding-bottom: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                <RadzenText Text="Tạo mã quản lý" Style="font-size: 16px; color: darkred; font-weight: 600;"></RadzenText>
                            </RadzenStack>
                            <!------>
                            <RadzenStack Gap="15px" Style="width: 100%; height: contain; padding-left: 20px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                <!--Chọn theo ngày-->
                                <RadzenStack Gap="5px" Style="width: 50%; height: contain;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 100%; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Chọn theo ngày" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 100%; height: contain;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenDatePicker TValue="DateTime" ValueChanged="@((args) => { autoAddNVL.FistMaQL = args.ToString("yyMM"); })"
                                                          ShowTime="false" HourFormat="12" DateFormat="@Common.DayTimeFormatnoTime" AllowInput="false"
                                                          Name="DatePicker" Style="width: 100%; border-radius: 10px; font-size: 14px">
                                            @* <FooterTemplate>
                                                <RadzenStack Style="padding: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenButton Style="height: 100%; width: 50%;" Text="Today" Click="@(() => { autoAddNVL.FistMaQL = DateTime.Now.ToString("yyMM"); })" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                                                </RadzenStack>
                                            </FooterTemplate> *@
                                        </RadzenDatePicker>
                                    </RadzenStack>
                                </RadzenStack>
                                <!--4 Ký tự đầu-->
                                <RadzenStack Gap="5px" Style="width: 50%; height: contain; padding-right: 10px; " Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 100%; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="4 ký tự đầu" Style="font-size: 14px; font-weight: 600;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 100%; height: contain;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenTextBox @bind-Value="@autoAddNVL.FistMaQL" Style="font-size: 14px; width: 100%; height: contain; border-radius: 5px; border-width: 1px;"></RadzenTextBox>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenStack Style="width: 100%; height: contain; padding-left: 20px; padding-right: 10px;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                <RadzenButton Icon="autorenew" Text="Tạo mã quản lý lot" Click="@(() => OnCreateAutoNewNVL())"
                                              Style="border-radius: 5px; width: 100%; background-color: Highlight" Variant="Variant.Flat" ButtonStyle="ButtonStyle.Success" Shade="Shade.Default" Size="ButtonSize.Small" />
                            </RadzenStack>
                        </RadzenStack>

                    </RadzenCard>
                </RadzenStack>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="8" Style="height: 100%; width: 100%;">
                <DialogReviewAutoAddListNVLs DanhSachNVLs="@autoAddNVL.ListNVLs"></DialogReviewAutoAddListNVLs>
            </RadzenColumn>
        </RadzenRow>
    </RadzenCard>
    <RadzenStack Gap="10px" Style="height: 5%; width: 100%; padding-left: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
        <RadzenButton Style="width: contain; color: white; background-color: darkred" Icon="close" Text="Thoát" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => DialogService.Close())" />
    </RadzenStack>
</RadzenStack>
@code {
    private AutoAddNVL autoAddNVL = new();

    [Parameter]
    public string Masanpham { get; set; } = string.Empty;

    protected override Task OnInitializedAsync()
    {
        autoAddNVL.MaSP = Masanpham;

        return base.OnInitializedAsync();
    }

    private void OnCreateAutoNewNVL()
    {
        NVL? lastNVL = SQLServerServices.GetlistNVLbyLoaiNL(autoAddNVL.LoaiNL).LastOrDefault();

        try
        {
            int lastID = 0;

            if (lastNVL != null)
            {
                lastID = int.Parse(lastNVL.MaQuanLy.Value?.ToString()?.Substring(11) ?? "0");
            }

            autoAddNVL.CreateListNVLs_2(lastID + 1);
        }
        catch (Exception)
        {
            return;
        }
    }
}
