@using Microsoft.AspNetCore.Identity
@using ProcessManagement.Commons
@using ProcessManagement.Models
@using Radzen
@using Radzen.Blazor
@using System.Linq
@using System.Text.RegularExpressions

@inject IHttpClientFactory HttpClientFactory
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject UserManager<AppUser> UserManager

<RadzenTemplateForm TItem="ChangePasswordModel" Data="@changePasswordModel" Submit="@ChangePassword">
    <RadzenStack Gap="24px">
        <RadzenStack Gap="8px">
            <RadzenLabel Text="ƒê·ªïi m·∫≠t kh·∫©u" Style="font-size: 20px; font-weight: 600; color: #1976d2;" />
            <RadzenLabel Text="@($"Ng∆∞·ªùi d√πng: {userName}")" Style="font-size: 14px; color: #666;" />
        </RadzenStack>
        
        @if (isViewCurrentPassword)
        {
            <RadzenCard Style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 2px solid #2196F3; border-radius: 8px; padding: 16px;">
                <RadzenStack Gap="8px">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                        <RadzenIcon Icon="lock" Style="color: #1976d2; font-size: 20px;" />
                        <RadzenLabel Text="M·∫≠t kh·∫©u hi·ªán t·∫°i:" Style="font-weight: 600; color: #1976d2;" />
                    </RadzenStack>
                    <RadzenLabel Text="@currentPassword" 
                                 Style="font-family: 'Courier New', monospace; font-size: 20px; color: #1976d2; font-weight: bold; padding: 12px; background: white; border-radius: 6px; text-align: center; letter-spacing: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" />
                    <RadzenLabel Text="üí° B·∫°n c√≥ th·ªÉ ch·ªânh s·ª≠a m·∫≠t kh·∫©u b√™n d∆∞·ªõi ho·∫∑c gi·ªØ nguy√™n" 
                                 Style="color: #1976d2; font-size: 12px; font-weight: 500; margin-top: 4px;" />
                </RadzenStack>
            </RadzenCard>
        }

        <RadzenStack Gap="16px" Style="padding: 0;">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" AlignItems="AlignItems.Center" Style="justify-content: space-between;">
                <RadzenLabel Text="M·∫≠t kh·∫©u m·ªõi" Style="font-weight: 500;" />
                @if (!isViewCurrentPassword && !string.IsNullOrEmpty(UserId))
                {
                    <RadzenButton Text="Xem m·∫≠t kh·∫©u hi·ªán t·∫°i" 
                                 Icon="visibility" 
                                 ButtonStyle="ButtonStyle.Success" 
                                 Size="ButtonSize.Small"
                                 Click="@ViewCurrentPassword"
                                 Disabled="@isLoading"
                                 Style="margin-left: auto;" />
                }
            </RadzenStack>
            
            <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="changePasswordModel.NewPassword" 
                             Name="NewPassword" 
                             class="w-100" 
                             Placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi (t·ªëi thi·ªÉu 6 k√Ω t·ª±)"
                             InputType="@(showPassword ? "text" : "password")"
                             Style="flex: 1;"
                             @oninput="@OnPasswordInput" />
                <RadzenButton Icon="@(showPassword ? "visibility_off" : "visibility")" 
                             ButtonStyle="ButtonStyle.Light" 
                             Size="ButtonSize.Small"
                             Click="@TogglePasswordVisibility"
                             Title="@(showPassword ? "·∫®n" : "Hi·ªán")" />
            </RadzenStack>
            <RadzenRequiredValidator Component="NewPassword" Text="Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi" />
            
            @* Hi·ªÉn th·ªã password rules *@
            <RadzenStack Gap="4px" Style="padding-left: 8px;">
                <RadzenLabel Text="Y√™u c·∫ßu m·∫≠t kh·∫©u:" Style="font-size: 12px; font-weight: 600; color: #666;" />
                <RadzenStack Gap="2px" Style="padding-left: 16px;">
                    <RadzenLabel Text="‚úì T·ªëi thi·ªÉu 6 k√Ω t·ª±" 
                                 Style="@($"font-size: 11px; color: {(passwordRules.MinLength ? "#4caf50" : "#999")}")" />
                    @* C√≥ th·ªÉ th√™m c√°c rules kh√°c n·∫øu c·∫ßn *@
                </RadzenStack>
            </RadzenStack>
        </RadzenStack>

        <RadzenStack Gap="16px">
            <RadzenLabel Text="X√°c nh·∫≠n m·∫≠t kh·∫©u" Style="font-weight: 500;" />
            <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="changePasswordModel.ConfirmPassword" 
                             Name="ConfirmPassword" 
                             class="w-100" 
                             Placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
                             InputType="@(showConfirmPassword ? "text" : "password")"
                             Style="flex: 1;" />
                <RadzenButton Icon="@(showConfirmPassword ? "visibility_off" : "visibility")" 
                             ButtonStyle="ButtonStyle.Light" 
                             Size="ButtonSize.Small"
                             Click="@ToggleConfirmPasswordVisibility"
                             Title="@(showConfirmPassword ? "·∫®n" : "Hi·ªán")" />
            </RadzenStack>
            <RadzenRequiredValidator Component="ConfirmPassword" Text="Vui l√≤ng x√°c nh·∫≠n m·∫≠t kh·∫©u" />
            <RadzenCompareValidator Component="ConfirmPassword"
                                   Value="changePasswordModel.NewPassword"
                                   Text="M·∫≠t kh·∫©u kh√¥ng kh·ªõp" />
        </RadzenStack>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" JustifyContent="JustifyContent.End" Style="margin-top: 8px;">
            <RadzenButton Text="H·ªßy" 
                         Icon="cancel" 
                         ButtonStyle="ButtonStyle.Light" 
                         Click="@CloseDialog"
                         Disabled="@isLoading" />
            <RadzenButton ButtonType="ButtonType.Submit" 
                         Text="ƒê·ªïi m·∫≠t kh·∫©u" 
                         Icon="lock" 
                         ButtonStyle="ButtonStyle.Primary" 
                         Disabled="@(isLoading || !IsPasswordValid)" />
        </RadzenStack>
    </RadzenStack>
</RadzenTemplateForm>

@code {
    [Parameter] public string UserId { get; set; } = string.Empty;
    [Parameter] public string UserName { get; set; } = string.Empty;

    private ChangePasswordModel changePasswordModel = new();
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private bool isLoading = false;
    private string userName = string.Empty;
    private bool isViewCurrentPassword = false;
    private string currentPassword = string.Empty;

    // Password rules validation
    private PasswordRules passwordRules = new();
    private const int MIN_PASSWORD_LENGTH = 6;

    private bool IsPasswordValid => 
        !string.IsNullOrEmpty(changePasswordModel.NewPassword) && 
        changePasswordModel.NewPassword.Length >= MIN_PASSWORD_LENGTH &&
        changePasswordModel.NewPassword == changePasswordModel.ConfirmPassword;

    protected override async Task OnInitializedAsync()
    {
        userName = UserName;
        if (string.IsNullOrEmpty(userName) && !string.IsNullOrEmpty(UserId))
        {
            var user = await UserManager.FindByIdAsync(UserId);
            userName = user?.UserName ?? "N/A";
        }
        await base.OnInitializedAsync();
    }

    private void OnPasswordInput(ChangeEventArgs e)
    {
        var password = e.Value?.ToString() ?? string.Empty;
        passwordRules.MinLength = password.Length >= MIN_PASSWORD_LENGTH;
        StateHasChanged();
    }

    private void TogglePasswordVisibility()
    {
        showPassword = !showPassword;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        showConfirmPassword = !showConfirmPassword;
    }

    private async Task ViewCurrentPassword()
    {
        if (string.IsNullOrEmpty(UserId))
            return;

        isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);
            var response = await client.GetAsync($"api/user/{UserId}/get-password");

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<PasswordResponse>();
                if (result != null && !string.IsNullOrEmpty(result.Password))
                {
                    currentPassword = result.Password;
                    isViewCurrentPassword = true;
                    // T·ª± ƒë·ªông ƒëi·ªÅn v√†o form - ng∆∞·ªùi d√πng c√≥ th·ªÉ ch·ªânh s·ª≠a
                    changePasswordModel.NewPassword = result.Password;
                    changePasswordModel.ConfirmPassword = result.Password;
                    showPassword = true;
                    showConfirmPassword = true;
                    passwordRules.MinLength = result.Password.Length >= MIN_PASSWORD_LENGTH;
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Warning, "Th√¥ng b√°o", "Ch∆∞a c√≥ m·∫≠t kh·∫©u ƒë∆∞·ª£c l∆∞u trong h·ªá th·ªëng.");
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Th√¥ng b√°o", "Ch∆∞a c√≥ m·∫≠t kh·∫©u ƒë∆∞·ª£c l∆∞u. Vui l√≤ng ƒë·ªïi m·∫≠t kh·∫©u ƒë·ªÉ l∆∞u v√†o h·ªá th·ªëng.");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "L·ªói", $"Kh√¥ng th·ªÉ l·∫•y m·∫≠t kh·∫©u: {error}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", $"ƒê√£ x·∫£y ra l·ªói: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ChangePassword()
    {
        if (string.IsNullOrEmpty(UserId))
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", "User ID kh√¥ng h·ª£p l·ªá");
            return;
        }

        // Validation
        if (string.IsNullOrEmpty(changePasswordModel.NewPassword))
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi");
            return;
        }

        if (changePasswordModel.NewPassword.Length < MIN_PASSWORD_LENGTH)
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", $"M·∫≠t kh·∫©u ph·∫£i c√≥ t·ªëi thi·ªÉu {MIN_PASSWORD_LENGTH} k√Ω t·ª±");
            return;
        }

        if (changePasswordModel.NewPassword != changePasswordModel.ConfirmPassword)
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", "M·∫≠t kh·∫©u kh√¥ng kh·ªõp");
            return;
        }

        isLoading = true;
        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);
            var response = await client.PostAsJsonAsync($"api/user/{UserId}/change-password", 
                new { NewPassword = changePasswordModel.NewPassword });

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Th√†nh c√¥ng", "ƒê√£ ƒë·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng");
                DialogService.Close(true);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                NotificationService.Notify(NotificationSeverity.Error, "L·ªói", $"Kh√¥ng th·ªÉ ƒë·ªïi m·∫≠t kh·∫©u: {error}");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "L·ªói", $"ƒê√£ x·∫£y ra l·ªói: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void CloseDialog()
    {
        DialogService.Close(false);
    }

    public class ChangePasswordModel
    {
        public string NewPassword { get; set; } = string.Empty;
        public string ConfirmPassword { get; set; } = string.Empty;
    }

    public class PasswordResponse
    {
        public string Password { get; set; } = string.Empty;
        public DateTime LastUpdated { get; set; }
    }

    public class PasswordRules
    {
        public bool MinLength { get; set; } = false;
        // C√≥ th·ªÉ th√™m c√°c rules kh√°c: HasUpperCase, HasLowerCase, HasDigit, HasSpecialChar, etc.
    }
}
