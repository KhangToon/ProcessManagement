@using System.Linq
@using ProcessManagement.Models.Authorization
@using ProcessManagement.Services.Authorization
@using Radzen
@using Radzen.Blazor

@inject PermissionService PermissionService
@inject NotificationService NotificationService
@inject DialogService DialogService

<div style="display: flex; flex-direction: column; max-height: 70vh;">
    @* Header *@
    <div style="flex: 0 0 auto; padding: 16px; border-bottom: 1px solid #e0e0e0;">
        <RadzenStack Gap="8px">
            <RadzenLabel Text="Quyền mặc định của Role" Style="font-size: 18px; font-weight: bold;" />
            <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                <RadzenLabel Text="Role:" Style="font-size: 14px; color: #666;" />
                <RadzenLabel Text="@RoleName" Style="font-weight: bold; font-size: 16px; color: #1976d2;" />
            </RadzenStack>
        </RadzenStack>
    </div>

    @* Body - Scrollable permissions list *@
    <div style="flex: 1 1 auto; overflow-y: auto; padding: 16px; max-height: 400px;">
        @if (isLoading)
        {
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px" JustifyContent="JustifyContent.Center" Style="padding: 20px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenLabel Text="Đang tải..." />
            </RadzenStack>
        }
        else if (permissionsByModule.Any())
        {
            <RadzenStack Gap="10px">
                @foreach (var module in permissionsByModule)
                {
                    <RadzenCard>
                        <RadzenStack Gap="8px">
                            <RadzenLabel Text="@module.Key" Style="font-weight: bold; font-size: 14px;" />
                            <RadzenStack Gap="5px" Orientation="Orientation.Vertical">
                                @foreach (var permission in module.Value)
                                {
                                    var isChecked = rolePermissions.Contains(permission);
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                        <RadzenIcon Icon="@(isChecked ? "check_circle" : "cancel")" 
                                                   Style="@($"color: {(isChecked ? "green" : "lightgray")}; font-size: 18px;")" />
                                        <RadzenLabel Text="@GetPermissionDisplayName(permission)" 
                                                   Style="@(!isChecked ? "color: lightgray;" : "")" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        }
        else
        {
            <RadzenLabel Text="Role này chưa có quyền nào được gán." Style="color: #666; text-align: center; padding: 20px;" />
        }
    </div>

    @* Footer *@
    <div style="flex: 0 0 auto; padding: 12px 16px; border-top: 1px solid #e0e0e0;">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" JustifyContent="JustifyContent.End">
            <RadzenButton Text="Đóng" 
                         Icon="cancel" 
                         ButtonStyle="ButtonStyle.Light" 
                         Click="@Close" />
        </RadzenStack>
    </div>
</div>

@code {
    [Parameter] public string RoleName { get; set; } = string.Empty;
    
    private Dictionary<string, List<string>> permissionsByModule = new();
    private HashSet<string> rolePermissions = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        permissionsByModule = Permissions.GetAllPermissionsByModule();
        
        if (!string.IsNullOrEmpty(RoleName))
        {
            await LoadRolePermissions();
        }
        else
        {
            isLoading = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(RoleName))
        {
            await LoadRolePermissions();
        }
    }

    private async Task LoadRolePermissions()
    {
        isLoading = true;
        try
        {
            var permissions = await PermissionService.GetRolePermissionsAsync(RoleName);
            rolePermissions = permissions.ToHashSet();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi", $"Không thể tải quyền: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private string GetPermissionDisplayName(string permission)
    {
        if (permission.Contains("View"))
            return "Xem";
        if (permission.Contains("Create"))
            return "Tạo mới";
        if (permission.Contains("Update"))
            return "Cập nhật";
        if (permission.Contains("Delete"))
            return "Xóa";
        if (permission.Contains("NhapKho"))
            return "Nhập kho";
        if (permission.Contains("XuatKho"))
            return "Xuất kho";
        if (permission.Contains("KiemKe"))
            return "Kiểm kê";
        if (permission.Contains("ManagePermissions"))
            return "Quản lý quyền";
        
        return permission;
    }

    private void Close()
    {
        DialogService.Close();
    }
}

