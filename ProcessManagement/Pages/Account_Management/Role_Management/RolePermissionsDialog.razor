@using System.Linq
@using Microsoft.AspNetCore.Identity
@using ProcessManagement.Models
@using ProcessManagement.Models.Authorization
@using ProcessManagement.Services.Authorization
@using Radzen
@using Radzen.Blazor

@inject PermissionService PermissionService
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenTemplateForm TItem="object">
    <div style="display: flex; flex-direction: column;">
        @* HEADER: Thông tin role + các nút chức năng *@
        <div style="flex: 0 0 auto; padding: 20px; border-bottom: 1px solid #e0e0e0; background: white;">
            <RadzenStack Gap="16px">
                @* Title và Action Buttons *@
                <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenLabel Text="@(isEditMode ? "Quản lý quyền mặc định cho role" : "Quyền mặc định của role")" Style="font-size: 18px; font-weight: bold;" />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px">
                        @if (isEditMode && hasChanges)
                        {
                            <RadzenButton Text="Nhập lại" 
                                         Icon="refresh" 
                                         ButtonStyle="ButtonStyle.Light" 
                                         Size="ButtonSize.Small"
                                         Click="@ResetPermissions"
                                         Disabled="@isLoading"
                                         Title="Khôi phục về giá trị ban đầu" />
                        }
                        <RadzenButton Text="@(isEditMode ? "Hủy chỉnh sửa" : "Điều chỉnh")" 
                                     Icon="@(isEditMode ? "cancel" : "edit")" 
                                     ButtonStyle="@(isEditMode ? ButtonStyle.Light : ButtonStyle.Primary)" 
                                     Size="ButtonSize.Small"
                                     Click="@ToggleEditMode"
                                     Disabled="@isLoading" />
                    </RadzenStack>
                </RadzenStack>
                
                @* Role Info *@
                <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                    <RadzenLabel Text="Role:" Style="font-size: 14px; color: #666;" />
                    <RadzenLabel Text="@RoleName" Style="font-weight: bold; font-size: 16px; color: #1976d2;" />
                </RadzenStack>
                
                @* Description *@
                <RadzenLabel Text="@(isEditMode ? "Chọn các quyền mặc định cho role (các user có role này sẽ tự động có các quyền này):" : "Danh sách quyền mặc định:")" Style="font-size: 14px; color: #666;" />
            </RadzenStack>
        </div>

        @* BODY: List permissions - scrollable với height cố định 500px *@
        <div style="height: 500px; overflow-y: auto; overflow-x: hidden; padding: 20px;">
            <RadzenStack Gap="10px">
                @* Checkbox chọn tất cả *@
                @if (isEditMode)
                {
                    <RadzenCard Style="background: #f5f5f5; border: 1px solid #e0e0e0;">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                            <RadzenCheckBox Value="@IsAllSelected()" 
                                           ValueChanged="@((bool value) => SelectAllPermissions(value))" />
                            <RadzenLabel Text="Chọn tất cả" Style="font-weight: bold; font-size: 14px;" />
                        </RadzenStack>
                    </RadzenCard>
                }

                @foreach (var module in permissionsByModule)
                {
                    <RadzenCard>
                        <RadzenStack Gap="10px">
                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px" JustifyContent="JustifyContent.SpaceBetween">
                                <RadzenLabel Text="@module.Key" Style="font-weight: bold; font-size: 16px;" />
                                @if (isEditMode)
                                {
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px">
                                        <RadzenCheckBox Value="@IsAllSelectedInModule(module.Key)" 
                                                       ValueChanged="@((bool value) => SelectAllInModule(module.Key, value))" />
                                        <RadzenLabel Text="Chọn tất cả" Style="font-size: 12px; color: #666;" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                            
                            <RadzenStack Gap="5px" Orientation="Orientation.Vertical">
                                @foreach (var permission in module.Value)
                                {
                                    var permissionKey = permission;
                                    var isChecked = permissionCheckboxes.ContainsKey(permissionKey) ? permissionCheckboxes[permissionKey] : selectedPermissions.Contains(permission);
                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="10px">
                                        @if (isEditMode)
                                        {
                                            <RadzenCheckBox Value="@isChecked" 
                                                           ValueChanged="@((bool value) => OnCheckboxChanged(permissionKey, value))" />
                                        }
                                        else
                                        {
                                            <RadzenIcon Icon="@(isChecked ? "check_circle" : "cancel")" 
                                                       Style="@($"color: {(isChecked ? "green" : "lightgray")}; font-size: 20px;")" />
                                        }
                                        <RadzenLabel Text="@GetPermissionDisplayName(permission)" 
                                                   Style="@(!isEditMode && !isChecked ? "color: lightgray;" : "")" />
                                    </RadzenStack>
                                }
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                }
            </RadzenStack>
        </div>
        
        @* FOOTER: Các nút confirm *@
        <div style="flex: 0 0 auto; background: white; padding: 12px 20px; border-top: 1px solid #e0e0e0;">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" JustifyContent="JustifyContent.End">
                @if (isEditMode)
                {
                    <RadzenButton Text="Hủy" 
                                 Icon="cancel" 
                                 ButtonStyle="ButtonStyle.Light" 
                                 Click="@ExitEditMode" 
                                 Disabled="@isLoading" />
                    <RadzenButton Text="Lưu" 
                                 Icon="save" 
                                 ButtonStyle="ButtonStyle.Primary" 
                                 Click="@OnSave" 
                                 Disabled="@(isLoading || !hasChanges)" />
                }
                else
                {
                    <RadzenButton Text="Đóng" 
                                 Icon="cancel" 
                                 ButtonStyle="ButtonStyle.Light" 
                                 Click="@OnCancel" />
                }
            </RadzenStack>
        </div>
    </div>
</RadzenTemplateForm>

@code {
    [Parameter] public string RoleName { get; set; } = string.Empty;
    [Parameter] public bool IsEditMode { get; set; } = false; // Mặc định là view mode
    
    private Dictionary<string, List<string>> permissionsByModule = new();
    private HashSet<string> selectedPermissions = new();
    private HashSet<string> originalPermissions = new(); // Lưu permissions gốc để so sánh
    private Dictionary<string, bool> permissionCheckboxes = new();
    private bool isLoading = false;
    private bool isEditMode = false; // Internal edit mode state
    private bool hasChanges = false; // Track changes

    protected override async Task OnInitializedAsync()
    {
        await LoadPermissions();
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Reload khi RoleName thay đổi
        if (!string.IsNullOrEmpty(RoleName))
        {
            await LoadPermissions();
        }
        await base.OnParametersSetAsync();
    }

    private async Task LoadPermissions()
    {
        // Set edit mode từ parameter
        isEditMode = IsEditMode;
        
        if (!string.IsNullOrEmpty(RoleName))
        {
            // Lấy permissions hiện có của role từ database
            var rolePermissions = await PermissionService.GetRolePermissionsAsync(RoleName);
            selectedPermissions = rolePermissions.ToHashSet();
            originalPermissions = new HashSet<string>(selectedPermissions); // Lưu bản gốc
            
            // Initialize checkboxes với permissions hiện có
            permissionCheckboxes.Clear();
            foreach (var permission in selectedPermissions)
            {
                permissionCheckboxes[permission] = true;
            }
            
            // Reset changes tracking
            hasChanges = false;
        }

        // Load tất cả permissions theo module
        permissionsByModule = Permissions.GetAllPermissionsByModule();
    }

    private void OnCheckboxChanged(string permission, bool isChecked)
    {
        // Update checkbox state
        permissionCheckboxes[permission] = isChecked;

        // Update selected permissions
        if (isChecked)
        {
            selectedPermissions.Add(permission);
        }
        else
        {
            selectedPermissions.Remove(permission);
        }

        CheckForChanges();
        StateHasChanged();
    }

    private void CheckForChanges()
    {
        hasChanges = !selectedPermissions.SetEquals(originalPermissions);
    }

    private void ToggleEditMode()
    {
        isEditMode = !isEditMode;
        
        if (!isEditMode)
        {
            // Exit edit mode - reset to original
            selectedPermissions = new HashSet<string>(originalPermissions);
            permissionCheckboxes.Clear();
            foreach (var permission in selectedPermissions)
            {
                permissionCheckboxes[permission] = true;
            }
            hasChanges = false;
        }
        
        StateHasChanged();
    }

    private void ExitEditMode()
    {
        ToggleEditMode();
    }

    private void ResetPermissions()
    {
        selectedPermissions = new HashSet<string>(originalPermissions);
        permissionCheckboxes.Clear();
        foreach (var permission in selectedPermissions)
        {
            permissionCheckboxes[permission] = true;
        }
        hasChanges = false;
        StateHasChanged();
    }

    private async Task OnSave()
    {
        if (string.IsNullOrEmpty(RoleName))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi", "Role name không hợp lệ");
            return;
        }

        isLoading = true;
        try
        {
            var result = await PermissionService.AssignRolePermissionsAsync(RoleName, selectedPermissions.ToList());
            
            if (result)
            {
                // Reload permissions từ database để đảm bảo đồng bộ
                var updatedPermissions = await PermissionService.GetRolePermissionsAsync(RoleName);
                selectedPermissions = updatedPermissions.ToHashSet();
                originalPermissions = new HashSet<string>(selectedPermissions); // Cập nhật bản gốc
                
                // Update checkboxes
                permissionCheckboxes.Clear();
                foreach (var permission in selectedPermissions)
                {
                    permissionCheckboxes[permission] = true;
                }
                
                hasChanges = false;
                
                NotificationService.Notify(NotificationSeverity.Success, "Thành công", "Đã lưu quyền mặc định cho role");
                
                // Đóng dialog
                DialogService.Close(true);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Lỗi", "Không thể lưu quyền mặc định cho role");
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi", $"Lỗi khi lưu: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnCancel()
    {
        DialogService.Close();
    }

    private string GetPermissionDisplayName(string permission)
    {
        // Chuyển đổi permission thành tên hiển thị dễ hiểu
        if (permission.Contains("View"))
            return "Xem";
        if (permission.Contains("Create"))
            return "Tạo mới";
        if (permission.Contains("Update"))
            return "Cập nhật";
        if (permission.Contains("Delete"))
            return "Xóa";
        if (permission.Contains("NhapKho"))
            return "Nhập kho";
        if (permission.Contains("XuatKho"))
            return "Xuất kho";
        if (permission.Contains("KiemKe"))
            return "Kiểm kê";
        if (permission.Contains("ManagePermissions"))
            return "Quản lý quyền";
        
        return permission;
    }

    private bool IsAllSelected()
    {
        // Kiểm tra xem tất cả permissions đã được chọn chưa
        var allPermissions = Permissions.GetAllPermissions();
        return allPermissions.All(p => selectedPermissions.Contains(p));
    }

    private bool IsAllSelectedInModule(string moduleKey)
    {
        // Kiểm tra xem tất cả permissions trong module đã được chọn chưa
        if (!permissionsByModule.ContainsKey(moduleKey))
            return false;
        
        var modulePermissions = permissionsByModule[moduleKey];
        return modulePermissions.All(p => selectedPermissions.Contains(p));
    }

    private void SelectAllPermissions(bool selectAll)
    {
        var allPermissions = Permissions.GetAllPermissions();
        
        if (selectAll)
        {
            // Chọn tất cả
            foreach (var permission in allPermissions)
            {
                if (!selectedPermissions.Contains(permission))
                {
                    selectedPermissions.Add(permission);
                    permissionCheckboxes[permission] = true;
                }
            }
        }
        else
        {
            // Bỏ chọn tất cả
            foreach (var permission in allPermissions)
            {
                selectedPermissions.Remove(permission);
                permissionCheckboxes[permission] = false;
            }
        }
        
        CheckForChanges();
        StateHasChanged();
    }

    private void SelectAllInModule(string moduleKey, bool selectAll)
    {
        if (!permissionsByModule.ContainsKey(moduleKey))
            return;
        
        var modulePermissions = permissionsByModule[moduleKey];
        
        if (selectAll)
        {
            // Chọn tất cả trong module
            foreach (var permission in modulePermissions)
            {
                if (!selectedPermissions.Contains(permission))
                {
                    selectedPermissions.Add(permission);
                    permissionCheckboxes[permission] = true;
                }
            }
        }
        else
        {
            // Bỏ chọn tất cả trong module
            foreach (var permission in modulePermissions)
            {
                selectedPermissions.Remove(permission);
                permissionCheckboxes[permission] = false;
            }
        }
        
        CheckForChanges();
        StateHasChanged();
    }
}

