@page "/role-management"
@namespace ProcessManagement.Pages.Account_Management.Role_Management
@attribute [Authorize(Roles = "Admin")]

@using System.Net.Http.Json
@using System.Text
@using System.Text.Json
@using System.Linq
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authorization
@using ProcessManagement.Commons
@using ProcessManagement.Pages.Account_Management.Role_Management
@using ProcessManagement.Pages.Account_Management.Role_Management.Models
@using ProcessManagement.Pages.Account_Management.User_Management.Models
@using ProcessManagement.Services.Authorization
@using Radzen
@using Radzen.Blazor

@inject IHttpClientFactory HttpClientFactory
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject PermissionService PermissionService

<div class="row mb-4">
    <div class="col">
        <RadzenCard>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="m-0">Danh sách Roles</h3>
                <div>
                    <RadzenButton Text="Thêm Role" Icon="add" ButtonStyle="ButtonStyle.Primary" Click="@OpenCreateRoleDialog" />
                </div>
            </div>


            <RadzenDataGrid @ref="rolesGrid" Data="@roles" TItem="IdentityRole"
                            AllowSorting="true" AllowFiltering="false" AllowPaging="true" PageSize="10"
                            FilterMode="FilterMode.Advanced" Count="@count"
                            IsLoading="@isLoading">
                <Columns>
                    <RadzenDataGridColumn TItem="IdentityRole" Property="Id" Title="STT" Width="150px" TextAlign="TextAlign.Center">
                        <Template Context="role">
                            @(roles.IndexOf(role) + 1)
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="IdentityRole" Property="Name" Title="Role Name" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="IdentityRole" Property="NormalizedName" Title="Normalized Name" TextAlign="TextAlign.Center" />
                    <RadzenDataGridColumn TItem="IdentityRole" Width="180px" Title="Quyền mặc định" TextAlign="TextAlign.Center">
                        <Template Context="role">
                            <RadzenButton Icon="security" 
                                         Text="Quyền"
                                         ButtonStyle="ButtonStyle.Info" 
                                         Size="ButtonSize.Small"
                                         Click="@(() => OpenRolePermissionsDialog(role.Name ?? string.Empty))"
                                         Title="Xem và điều chỉnh quyền mặc định cho role" />
                        </Template>
                    </RadzenDataGridColumn>
                    <RadzenDataGridColumn TItem="IdentityRole" Width="200px" Title="Actions" TextAlign="TextAlign.Center">
                        <Template Context="role">
                            <RadzenStack Gap="6px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenButton Icon="edit" 
                                             ButtonStyle="ButtonStyle.Primary" 
                                             Size="ButtonSize.Small"
                                             Click="@(() => OpenEditRoleDialog(role.Name ?? string.Empty))"
                                             Title="Chỉnh sửa role" />
                                <RadzenButton Icon="delete" 
                                             ButtonStyle="ButtonStyle.Danger" 
                                             Size="ButtonSize.Small" 
                                             Shade="Shade.Lighter"
                                             Click="@(() => DeleteRole(role.Name ?? string.Empty))"
                                             Title="Xóa role" />
                            </RadzenStack>
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenCard>
    </div>
</div>

<div class="row">
    <div class="col">
        <RadzenCard>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="m-0">Gán Role cho User</h3>
            </div>

            <RadzenTemplateForm TItem="AssignRoleRequest" Data="@assignRoleModel" Submit="@(async() => await AssignRole())">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <RadzenLabel Text="User" />
                        <RadzenDropDown @bind-Value="@assignRoleModel.UserId" Data="@users"
                                        ValueProperty="Id" 
                                        Name="UserId" 
                                        class="w-100"
                                        Placeholder="Chọn user"
                                        Change="@(async (object value) => await OnUserSelected(value))">
                            <Template Context="user">
                                <RadzenStack Gap="8px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%;">
                                    <span>@($"{user.Username} ({user.Email})")</span>
                                    @if (user.Roles != null && user.Roles.Count > 0)
                                    {
                                        <RadzenBadge Text="@user.Roles[0]" Variant="Variant.Filled" BadgeStyle="BadgeStyle.Success" Style="font-size: 11px;" />
                                    }
                                    else
                                    {
                                        <RadzenBadge Text="Chưa có role" Variant="Variant.Filled" BadgeStyle="BadgeStyle.Warning" Style="font-size: 11px;" />
                                    }
                                </RadzenStack>
                            </Template>
                            <ValueTemplate Context="user">
                                <RadzenStack Gap="8px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="width: 100%;">
                                    <span>@($"{user.Username} ({user.Email})")</span>
                                    @if (user.Roles != null && user.Roles.Count > 0)
                                    {
                                        <RadzenBadge Text="@user.Roles[0]" Variant="Variant.Filled" BadgeStyle="BadgeStyle.Success" Style="font-size: 11px;" />
                                    }
                                    else
                                    {
                                        <RadzenBadge Text="Chưa có role" Variant="Variant.Filled" BadgeStyle="BadgeStyle.Warning" Style="font-size: 11px;" />
                                    }
                                </RadzenStack>
                            </ValueTemplate>
                        </RadzenDropDown>
                        <RadzenRequiredValidator Component="UserId" Text="User is required" />
                    </div>
                    <div class="col-md-6">
                        <RadzenLabel Text="Role" />
                        <RadzenDropDown @bind-Value="@assignRoleModel.RoleName" Data="@roles"
                                        TextProperty="Name" ValueProperty="Name" Name="RoleName" class="w-100" Placeholder="Chọn role" />
                        <RadzenRequiredValidator Component="RoleName" Text="Role is required" />
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <RadzenButton Visible=@(!string.IsNullOrEmpty(assignRoleModel.UserId) && !string.IsNullOrEmpty(assignRoleModel.RoleName)) ButtonType="ButtonType.Submit" Text="Gán Role" Icon="assignment_ind"
                                      ButtonStyle="ButtonStyle.Primary" />
                    </div>
                </div>
            </RadzenTemplateForm>
        </RadzenCard>
    </div>
</div>

@code {
    private List<IdentityRole> roles = new List<IdentityRole>();
    private List<UserResponse> users = new List<UserResponse>();
    private RadzenDataGrid<IdentityRole> rolesGrid = new();
    private bool isLoading = false;
    private int count = 0;
    private AssignRoleRequest assignRoleModel = new AssignRoleRequest();
    private string currentUserRole = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);
            users = await client.GetFromJsonAsync<List<UserResponse>>("api/user") ?? new();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Failed to load users: {ex.Message}");
        }
    }

    private async Task OnUserSelected(object value)
    {
        if (value != null && value is string userId)
        {
            assignRoleModel.UserId = userId;
            await LoadCurrentUserRole(userId);
        }
        else
        {
            currentUserRole = string.Empty;
        }
        StateHasChanged();
    }

    private async Task LoadCurrentUserRole(string userId)
    {
        try
        {
            var user = users.FirstOrDefault(u => u.Id == userId);
            if (user != null && user.Roles != null && user.Roles.Any())
            {
                currentUserRole = user.Roles.FirstOrDefault() ?? string.Empty;
                // Tự động chọn role hiện tại trong dropdown
                assignRoleModel.RoleName = currentUserRole;
            }
            else
            {
                currentUserRole = string.Empty;
                assignRoleModel.RoleName = string.Empty;
            }
        }
        catch (Exception ex)
        {
            currentUserRole = string.Empty;
            NotificationService.Notify(NotificationSeverity.Warning, "Cảnh báo", $"Không thể load role của user: {ex.Message}");
        }
    }

    private async Task LoadRoles()
    {
        isLoading = true;

        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);

            var response = await client.GetAsync("api/roles");

            var rawContent = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"API error: Status code: {(int)response.StatusCode} ({response.StatusCode})");
            }
            else
            {
                try
                {
                    roles = JsonSerializer.Deserialize<List<IdentityRole>>(rawContent, new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? new();

                    count = roles.Count;
                }
                catch (JsonException jsonEx)
                {
                    NotificationService.Notify(NotificationSeverity.Error, "JSON Error", $"Could not parse JSON: {jsonEx.Message}");
                }
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", $"Could not load roles: {ex.Message}");
        }
        finally
        {
            isLoading = false;

            StateHasChanged();
        }
    }

    private async Task OpenCreateRoleDialog()
    {
        var result = await DialogService.OpenAsync<CreateRoleDialog>("Tạo Role Mới",
            new Dictionary<string, object>(),
            new DialogOptions { Width = "700px", Height = "auto", Resizable = true, Draggable = true });

        if (result is CreateRoleRequest request)
        {
            await CreateRole(request.RoleName, request.Permissions);
        }
    }

    private async Task OpenRolePermissionsDialog(string roleName)
    {
        if (string.IsNullOrEmpty(roleName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cảnh báo", "Tên role không hợp lệ");
            return;
        }

        var result = await DialogService.OpenAsync<RolePermissionsDialog>("Quản lý quyền mặc định cho role",
            new Dictionary<string, object> { { "RoleName", roleName }, { "IsEditMode", false } },
            new DialogOptions { Width = "700px", Height = "auto", Resizable = true, Draggable = true });

        if (result != null && result == true)
        {
            // Permissions đã được cập nhật
        }
    }

    private async Task OpenEditRoleDialog(string roleName)
    {
        if (string.IsNullOrEmpty(roleName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cảnh báo", "Tên role không hợp lệ");
            return;
        }

        var result = await DialogService.OpenAsync<EditRoleDialog>("Chỉnh sửa Role",
            new Dictionary<string, object> { { "CurrentRoleName", roleName } },
            new DialogOptions { Width = "500px", Height = "300px" });

        if (result is string newRoleName)
        {
            if (!string.IsNullOrEmpty(newRoleName))
            {
                await UpdateRole(roleName, newRoleName);
            }
        }
    }

    private async Task UpdateRole(string oldRoleName, string newRoleName)
    {
        if (string.IsNullOrEmpty(oldRoleName) || string.IsNullOrEmpty(newRoleName))
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi", "Tên role không được để trống");
            return;
        }

        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);

            var jsonContent = JsonSerializer.Serialize(newRoleName);
            var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");

            // URL encode role name để tránh lỗi với ký tự đặc biệt
            var encodedRoleName = Uri.EscapeDataString(oldRoleName);
            var response = await client.PutAsync($"api/roles/{encodedRoleName}", content);

            var rawContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Thành công",
                    $"Role '{oldRoleName}' đã được đổi tên thành '{newRoleName}'");

                await LoadRoles();
            }
            else
            {
                var preview = rawContent.Length > 200 ? rawContent.Substring(0, 200) + "..." : rawContent;

                NotificationService.Notify(NotificationSeverity.Error, "Lỗi",
                    $"Không thể cập nhật role: Status {(int)response.StatusCode} - {response.StatusCode}");

                NotificationService.Notify(NotificationSeverity.Error, "Chi tiết", preview);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi",
                $"Không thể cập nhật role: {ex.Message}");
        }
    }

    private async Task CreateRole(string roleName, List<string> permissions)
    {
        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);

            var request = new { RoleName = roleName, Permissions = permissions ?? new List<string>() };
            var jsonContent = JsonSerializer.Serialize(request);

            var content = new StringContent(jsonContent, Encoding.UTF8, "application/json");

            var response = await client.PostAsync("api/roles", content);

            var rawContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Thành công",
                    $"Role '{roleName}' đã được tạo thành công");

                await LoadRoles();
            }
            else
            {
                var preview = rawContent.Length > 200 ? rawContent.Substring(0, 200) + "..." : rawContent;

                NotificationService.Notify(NotificationSeverity.Error, "Lỗi",
                    $"Không thể tạo role: Status {(int)response.StatusCode} - {response.StatusCode}");

                NotificationService.Notify(NotificationSeverity.Error, "Chi tiết", preview);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi",
                $"Không thể tạo role: {ex.Message}");
        }
    }

    private async Task DeleteRole(string roleName)
    {
        if (string.IsNullOrEmpty(roleName))
        {
            return;
        }

        var confirmed = await DialogService.Confirm($"Are you sure you want to delete the role '{roleName}'?",
            "Delete Role", new ConfirmOptions { OkButtonText = "Yes", CancelButtonText = "No" });

        if (confirmed ?? false)
        {
            try
            {
                var client = HttpClientFactory.CreateClient(Common.ServerAPI);

                var response = await client.DeleteAsync($"api/roles/{roleName}");

                var rawContent = await response.Content.ReadAsStringAsync();

                if (response.IsSuccessStatusCode)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success",
                        $"Role '{roleName}' deleted successfully");

                    await LoadRoles();
                }
                else
                {
                    var preview = rawContent.Length > 200 ? rawContent.Substring(0, 200) + "..." : rawContent;
                    NotificationService.Notify(NotificationSeverity.Error, "Error",
                        $"Failed to delete role: Status {(int)response.StatusCode} - {response.StatusCode}");

                    NotificationService.Notify(NotificationSeverity.Error, "Response Content", preview);
                }
            }
            catch (Exception ex)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error",
                    $"Failed to delete role: {ex.Message}");
            }
        }
    }

    private async Task AssignRole()
    {
        try
        {
            var client = HttpClientFactory.CreateClient(Common.ServerAPI);

            var response = await client.PostAsJsonAsync("api/roles/assign", new
            {
                UserId = assignRoleModel.UserId,
                RoleName = assignRoleModel.RoleName
            });

            var rawContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Thành công",
                    "Role đã được gán thành công");

                // Reload users để cập nhật role
                await LoadUsers();
                
                // Reload role hiện tại của user
                if (!string.IsNullOrEmpty(assignRoleModel.UserId))
                {
                    await LoadCurrentUserRole(assignRoleModel.UserId);
                }

                // Clear form
                assignRoleModel = new AssignRoleRequest();
                currentUserRole = string.Empty;
            }
            else
            {
                var preview = rawContent.Length > 200 ? rawContent.Substring(0, 200) + "..." : rawContent;

                NotificationService.Notify(NotificationSeverity.Error, "Error",
                    $"Failed to assign role: Status {(int)response.StatusCode} - {response.StatusCode}");

                NotificationService.Notify(NotificationSeverity.Error, "Response Content", preview);
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error",
                $"Failed to assign role: {ex.Message}");
        }
    }


}