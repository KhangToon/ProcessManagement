@page "/reset-password"
@using Microsoft.AspNetCore.Components
@using Radzen
@using Radzen.Blazor
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject NotificationService NotificationService

<RadzenStack Gap="20px" Style="min-height: 100vh; padding: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
    <RadzenCard Style="max-width: 500px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
        <RadzenStack Gap="24px">
            <!-- Header -->
            <RadzenStack Gap="8px" AlignItems="AlignItems.Center">
                <RadzenIcon Icon="lock_reset" Style="font-size: 48px; color: #667eea;" />
                <RadzenLabel Text="Reset Mật Khẩu" Style="font-size: 28px; font-weight: bold; text-align: center;" />
                <RadzenLabel Text="Nhập username/email và mật khẩu mới" Style="font-size: 14px; color: #666; text-align: center;" />
            </RadzenStack>

            <!-- Warning -->
            <RadzenAlert Text="⚠️ Chức năng này chỉ dùng cho Development. Vui lòng xóa endpoint này trước khi deploy production!" 
                        AlertStyle="AlertStyle.Warning" 
                        AllowClose="false" 
                        Variant="Variant.Flat" />

            @if (showSuccess)
            {
                <!-- Success Message -->
                <RadzenCard Style="background: #d4edda; border: 1px solid #c3e6cb; padding: 16px;">
                    <RadzenStack Gap="12px">
                        <RadzenLabel Text="✓ Reset mật khẩu thành công!" Style="font-size: 16px; font-weight: bold; color: #155724;" />
                        <RadzenLabel Text="@($"Username: {resetResult?.Username ?? ""}")" Style="font-size: 14px; color: #155724;" />
                        <RadzenLabel Text="@($"Email: {resetResult?.Email ?? ""}")" Style="font-size: 14px; color: #155724;" />
                        <RadzenLabel Text="Bạn có thể đăng nhập ngay với mật khẩu mới!" Style="font-size: 14px; color: #155724;" />
                    </RadzenStack>
                </RadzenCard>

                <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" JustifyContent="JustifyContent.Center">
                    <RadzenButton Text="Đăng nhập ngay" 
                                 Icon="login" 
                                 ButtonStyle="ButtonStyle.Primary" 
                                 Click="@(() => Navigation.NavigateTo("/Identity/Account/Login"))" />
                    <RadzenButton Text="Reset tiếp" 
                                 Icon="refresh" 
                                 ButtonStyle="ButtonStyle.Light" 
                                 Click="@ResetForm" />
                </RadzenStack>
            }
            else
            {
                <!-- Form -->
                <RadzenTemplateForm TItem="ResetPasswordRequest" Data="@resetRequest" Submit="@OnSubmit">
                    <RadzenStack Gap="16px">
                        <!-- Username Input -->
                        <RadzenFormField Text="Username hoặc Email" class="w-100">
                            <RadzenTextBox @bind-Value="@resetRequest.Username" 
                                         Placeholder="Nhập username hoặc email"
                                         Style="width: 100%;"
                                         Disabled="@isLoading" />
                        </RadzenFormField>

                        <!-- New Password Input -->
                        <RadzenFormField Text="Mật khẩu mới" class="w-100">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center">
                                <RadzenTextBox @bind-Value="@resetRequest.NewPassword"
                                             Placeholder="Nhập mật khẩu mới"
                                             Style="flex: 1;"
                                             InputType="@(showPassword ? "text" : "password")"
                                             Disabled="@isLoading" />
                                <RadzenButton Icon="@(showPassword ? "visibility_off" : "visibility")"
                                             ButtonStyle="ButtonStyle.Secondary"
                                             Size="ButtonSize.Small"
                                             Click="@(() => showPassword = !showPassword)"
                                             Title="@(showPassword ? "Ẩn mật khẩu" : "Hiện mật khẩu")" />
                            </RadzenStack>
                        </RadzenFormField>

                        <!-- Confirm Password Input -->
                        <RadzenFormField Text="Xác nhận mật khẩu" class="w-100">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center">
                                <RadzenTextBox @bind-Value="@confirmPassword"
                                             Placeholder="Nhập lại mật khẩu mới"
                                             Style="flex: 1;"
                                             InputType="@(showConfirmPassword ? "text" : "password")"
                                             Disabled="@isLoading" />
                                <RadzenButton Icon="@(showConfirmPassword ? "visibility_off" : "visibility")"
                                             ButtonStyle="ButtonStyle.Secondary"
                                             Size="ButtonSize.Small"
                                             Click="@(() => showConfirmPassword = !showConfirmPassword)"
                                             Title="@(showConfirmPassword ? "Ẩn mật khẩu" : "Hiện mật khẩu")" />
                            </RadzenStack>
                        </RadzenFormField>

                        @if (!string.IsNullOrEmpty(passwordMismatchError))
                        {
                            <RadzenAlert Text="@passwordMismatchError" 
                                        AlertStyle="AlertStyle.Danger" 
                                        AllowClose="true"
                                        Close="@(() => passwordMismatchError = string.Empty)" />
                        }

                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <RadzenAlert Text="@errorMessage" 
                                        AlertStyle="AlertStyle.Danger" 
                                        AllowClose="true"
                                        Close="@(() => errorMessage = string.Empty)" />
                        }

                        <!-- Submit Button -->
                        <RadzenButton Text="Reset Mật Khẩu" 
                                     Icon="lock_reset" 
                                     ButtonStyle="ButtonStyle.Primary" 
                                     IsBusy="@isLoading"
                                     Disabled="@isLoading"
                                     Type="ButtonType.Submit"
                                     Style="width: 100%; height: 45px; font-size: 16px;" />

                        <!-- Back to Login -->
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" JustifyContent="JustifyContent.Center" AlignItems="AlignItems.Center">
                            <RadzenLabel Text="Nhớ mật khẩu?" Style="font-size: 14px; color: #666;" />
                            <RadzenLink Path="/Identity/Account/Login" Text="Đăng nhập" Style="font-size: 14px;" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenTemplateForm>
            }
        </RadzenStack>
    </RadzenCard>
</RadzenStack>

@code {
    private ResetPasswordRequest resetRequest = new();
    private string confirmPassword = string.Empty;
    private bool isLoading = false;
    private bool showPassword = false;
    private bool showConfirmPassword = false;
    private bool showSuccess = false;
    private string errorMessage = string.Empty;
    private string passwordMismatchError = string.Empty;
    private ResetPasswordResult? resetResult;

    private class ResetPasswordRequest
    {
        public string? Username { get; set; }
        public string NewPassword { get; set; } = string.Empty;
    }

    private class ResetPasswordResult
    {
        public bool Success { get; set; }
        public string? Message { get; set; }
        public string? Username { get; set; }
        public string? Email { get; set; }
    }

    private async Task OnSubmit()
    {
        errorMessage = string.Empty;
        passwordMismatchError = string.Empty;

        // Validate
        if (string.IsNullOrWhiteSpace(resetRequest.Username))
        {
            errorMessage = "Vui lòng nhập username hoặc email!";
            return;
        }

        if (string.IsNullOrWhiteSpace(resetRequest.NewPassword))
        {
            errorMessage = "Vui lòng nhập mật khẩu mới!";
            return;
        }

        if (resetRequest.NewPassword.Length < 3)
        {
            errorMessage = "Mật khẩu phải có ít nhất 3 ký tự!";
            return;
        }

        if (resetRequest.NewPassword != confirmPassword)
        {
            passwordMismatchError = "Mật khẩu xác nhận không khớp!";
            return;
        }

        isLoading = true;
        try
        {
            // Get base URL from NavigationManager
            var baseUrl = Navigation.BaseUri.TrimEnd('/');
            var apiUrl = $"{baseUrl}/api/user/emergency-reset-password";

            var response = await Http.PostAsJsonAsync(apiUrl, new
            {
                Username = resetRequest.Username,
                NewPassword = resetRequest.NewPassword
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<ResetPasswordResult>();
                if (result != null && result.Success)
                {
                    resetResult = result;
                    showSuccess = true;
                    NotificationService.Notify(NotificationSeverity.Success, "Thành công", "Đã reset mật khẩu thành công!");
                }
                else
                {
                    errorMessage = result?.Message ?? "Có lỗi xảy ra khi reset mật khẩu!";
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                try
                {
                    var errorObj = await response.Content.ReadFromJsonAsync<Dictionary<string, object>>();
                    if (errorObj != null && errorObj.ContainsKey("message"))
                    {
                        errorMessage = errorObj["message"]?.ToString() ?? "Có lỗi xảy ra!";
                    }
                    else
                    {
                        errorMessage = "Không thể reset mật khẩu. Vui lòng kiểm tra lại thông tin!";
                    }
                }
                catch
                {
                    errorMessage = $"Lỗi: {response.StatusCode} - {errorContent}";
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi kết nối: {ex.Message}";
            NotificationService.Notify(NotificationSeverity.Error, "Lỗi", errorMessage);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ResetForm()
    {
        resetRequest = new ResetPasswordRequest();
        confirmPassword = string.Empty;
        showSuccess = false;
        errorMessage = string.Empty;
        passwordMismatchError = string.Empty;
        resetResult = null;
    }
}

