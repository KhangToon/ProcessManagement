@page "/trackingkhsx"
@attribute [Authorize(Roles = "Admin, User")]
@* this limited access into page *@

@using ParamountBed_Warehouse.Services.SocketService
@using ProcessManagement.Commons
@using ProcessManagement.Models
@using ProcessManagement.Models.KHO_NVL.XuatKho
@using ProcessManagement.Models.KHSXs
@using ProcessManagement.Pages.KehoachSX.Dialogs
@using ProcessManagement.Pages.KehoachSX.KQGCs.Dialogs
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using Microsoft.AspNetCore.Components

@inject NotificationService NotificationService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SQLServerServices SQLServerServices
@inject ServerSocketAsync ServerSocketAsync
@inject NavigationManager NavigationManager

<style>
    .rz-grid-table-fixed-2 {
        border-radius: 10px;
        padding: 10px;
    }
</style>

<RadzenCard Variant="Variant.Flat" Style="height: 100%; width: 100%; padding-top: 15px">
    <RadzenStack Gap="5" Style="height: 100%; width: 100%;">
        <!--Thanh tim kiem-->
        <RadzenStack Style="height: contain; width: 100%; padding-bottom: 5px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Style="height: 100%; width: 100%; border-radius: 10px; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="THEO DÕI QUÁ TRÌNH GIA CÔNG" Style="color: green; font-weight: 600; font-size: 20px"></RadzenText>
            </RadzenStack>
        </RadzenStack>

        <!--Danh sach KetQuaGC-->
        <RadzenRow Gap="10px" Style="height: contain; width: 100%; border-top: var(--rz-grid-cell-border); padding: 0;">
            <!--Column bang danh sach ket qua gia cong-->
            <RadzenColumn Size="12" SizeMD="12" Style="height: contain; width: 100%;">
                <RadzenStack Gap="0px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start" Style="height: 100%; width: 100%;">
                    <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding: 5px; padding-left: 10px; border-bottom: var(--rz-grid-cell-border) " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Gap="10px" Style="height: 100%; width: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                            <RadzenText Text="Danh sách kết quả gia công" Style="color: darkred; font-weight: 600; font-size: 17px; height: contain; width: contain; font-style: italic;"></RadzenText>
                            <RadzenText Text="@($"( {DSachKetQuaGCs.Count} kết quả gia công )")" Style="color: black; font-weight: 600; font-size: 16px; height: contain; width: contain; font-style: italic;"></RadzenText>
                        </RadzenStack>

                        <!--Button them ket qua gia cong-->
                        <RadzenStack Style="height: 100%; width: contain; padding-left: 10px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenButton Click="OnThemMoiKetQuaGC" Icon="add" Text="Thêm kết quả gia công" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Success" Variant="Variant.Filled" Shade="Shade.Darker"
                                          Style="height: contain; width: contain; font-size: 14px;" />
                        </RadzenStack>

                        <!--Button enable advance filter-->
                        <RadzenStack Style="height: 100%; width: contain; padding-left: 10px; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">

                            <!--Button Reload-->
                            <RadzenStack Gap="15px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 100%; width: contain; padding-right: 20px; border-right: var(--rz-grid-cell-border);">
                                <RadzenButton Text="Reload" Click="@(async() => { await LoadAllDanhsachKQGCBase(300); await FilterDSachKetQuaGCProcessing(); })" IsBusy="@isLoadingKQGCs" BusyText=" Loading..." Style="border-radius: 20px;" Icon="autorenew" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" />
                            </RadzenStack>

                            <RadzenButton Icon="@(filterActive ? "filter_alt" : "filter_alt_off")" Text="Bộ lọc nâng cao" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="@(filterActive ? Shade.Darker : Shade.Lighter)"
                                          Style="height: contain; width: contain; font-size: 14px;"
                                          Click="@( async () =>
                                                                {
                                                                    if (filterActive)
                                                                    {
                                                                        await LoadAllDanhsachKQGCBase(0);
                                                                    }
                                                                    filterActive = !filterActive;
                                                                })" />
                            <RadzenButton Click="@(async () => {keyFilterExtraColumns = new(); keyFilterMainColumns = new(); await LoadAllDanhsachKQGCBase(0);})"
                                          Icon="reset_settings" Text="Reset bộ lọc" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                          Style="height: contain; width: contain; font-size: 14px;" />
                        </RadzenStack>
                    </RadzenStack>

                    <!--Datagrid danh sach ket qua gia cong-->
                    <RadzenStack Visible="@(DSachKetQuaGCs?.Count > 0)" Style="height: contain; width: 100%; padding-top: 10px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                        <RadzenDataGrid class="rz-grid-table-fixed-2" Data="@(DSachKetQuaGCs)" TItem="KetQuaGC" IsLoading="@isLoadingKQGCs"
                                        EmptyText="Danh sách theo dõi gia công trống." Style="overflow: scroll; width: 100%; height: 100%"
                                        ShowColumnTitleAsTooltip="true" ShowCellDataAsTooltip="true" AllowVirtualization="true"
                                        AllowFiltering="@filterActive" FilterMode="FilterMode.Simple" AllowColumnResize="true"
                                        AllowPaging="false" AllowSorting="false" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                        ShowPagingSummary="true" PagingSummaryFormat="@pagingSummaryFormat" PagerPosition="PagerPosition.Bottom"
                                        GridLines="DataGridGridLines.Both" Density="Density.Default"
                                        HeaderCellRender="@(args => args.Attributes.Add("style", $"background-color: rgba(58, 71, 77);"))"
                                        CellRender="@OnCellRender" Value="@DatagridSeleted" ValueChanged="@((args) => OnDatagridSelectChanged(args))">
                            <Columns>
                                @if (DSachKetQuaGCs?.Count > 0)
                                {
                                    List<Propertyy> columns = KetQuaGC.GetClassProperties() ?? new();

                                    <!--STT-->
                                    <RadzenDataGridColumn Width="50px" Frozen="true" FrozenPosition="FrozenColumnPosition.Left" Filterable="false"
                                                          TItem="KetQuaGC" Title="#"
                                                          Property="STT" TextAlign="TextAlign.Center">
                                        <HeaderTemplate>
                                            <span style="font-weight: 600; font-size: 15px; color: white">STT</span>
                                        </HeaderTemplate>
                                        <Template Context="kqgc">
                                            <span style="font-weight: bold;">@(DSachKetQuaGCs.IndexOf(kqgc) + 1)</span>
                                        </Template>
                                    </RadzenDataGridColumn>

                                    foreach (var column in columns.Where(cl => cl.DispDatagrid == true).ToList())
                                    {
                                        string colName = column.DBName ?? string.Empty;
                                        string displayName = column.DisplayName ?? string.Empty;
                                        Type? columnType = column.Type;

                                        <RadzenDataGridColumn TItem="KetQuaGC" Title="@displayName" MinWidth="100px"
                                                              Property="@colName" TextAlign="TextAlign.Center">
                                            <HeaderTemplate>
                                                <span style="font-weight: 600; font-size: 15px; color: white;">@displayName</span>
                                            </HeaderTemplate>
                                            <FilterTemplate>
                                                <RadzenDropDown AllowClear="true"
                                                                Style="width: 100%; height: contain; font-size: 14px; font-weight: 600; background-color: white"
                                                                AllowVirtualization="true"
                                                                AllowFiltering="true"
                                                                FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                                                FilterOperator="StringFilterOperator.Contains"
                                                                AllowSelectAll="true"
                                                                TValue="IEnumerable<string>"
                                                                Data="@(GetMainColumnKeysSearch(colName))"
                                                                Multiple="true"
                                                                SelectedItem="@(keyFilterMainColumns.ContainsKey(colName)? keyFilterMainColumns[colName] : null)"
                                                                Value="@(keyFilterMainColumns.ContainsKey(colName)? keyFilterMainColumns[colName] : null)"
                                                                ValueChanged="@((IEnumerable<string> args) => OnComboboxMainColumnSelectedChanged(args, colName))">
                                                </RadzenDropDown>
                                            </FilterTemplate>
                                            <Template Context="kqgc">
                                                @{
                                                    if (columnType != null && columnType == typeof(DateTime))
                                                    {
                                                        bool ishaveValueOfday = DateTime.TryParse(kqgc.GetPropertyValue(colName)?.ToString(), out DateTime vldate);

                                                        <RadzenText Visible="@ishaveValueOfday" Text="@vldate.ToString("dd/MM/yyyy")" Style="font-size: 16px; height: contain; color: black; font-weight: 500"></RadzenText>
                                                        <RadzenText Visible="@(!ishaveValueOfday)" Text="@string.Empty" Style="font-size: 16px; height: contain; color: black; font-weight: 500"></RadzenText>
                                                    }
                                                    else
                                                    {
                                                        if (colName == KetQuaGC.KQGCDBName.SPID || colName == KetQuaGC.KQGCDBName.MMID || colName == KetQuaGC.KQGCDBName.NCID || colName == KetQuaGC.KQGCDBName.NVIDs || colName == KetQuaGC.KQGCDBName.NGIDs)
                                                        {
                                                            <RadzenText Text="@(GetColumnValueByID(kqgc.GetPropertyValue(colName), colName))" Style="font-size: 15px; height: contain; font-weight: 500;"></RadzenText>
                                                        }
                                                        else
                                                        {
                                                            <RadzenText Text="@($"{kqgc.GetPropertyValue(colName)}")" Style="font-size: 15px; height: contain; font-weight: 500"></RadzenText>
                                                        }
                                                    }
                                                }
                                            </Template>
                                        </RadzenDataGridColumn>
                                    }
                                }
                            </Columns>
                        </RadzenDataGrid>
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>

    </RadzenStack>
</RadzenCard>

@code {
    private List<KetQuaGC> DSachKetQuaGCsBase = new();
    private List<KetQuaGC> DSachKetQuaGCs = new();
    private KetQuaGC SelectedKQGC = new();
    private IList<KetQuaGC>? DatagridSeleted;

    private DateTime startSearchDay = DateTime.Today;
    private DateTime endSearchDay = DateTime.Today;
    private string pagingSummaryFormat = "Displaying page {0} of {1} <b>(total {2} records)</b>";

    private Dictionary<string, List<string>> keyFilterMainColumns = new();
    private Dictionary<string, List<string>> keyFilterExtraColumns = new();
    private bool filterActive = false;

    private bool isLoadingKQGCs = false;


    protected override async Task OnInitializedAsync()
    {
        // Load ds KetQuaGC base/ hien thi
        await LoadAllDanhsachKQGCBase(0);

        // Khoi tao bien luu danh sach key search
        await CreateCurrentSelectedKeyVariable();

        await base.OnInitializedAsync();
    }

    // Convert ID to stringValue
    private string GetColumnValueByID(object? id, string colName)
    {
        string value = string.Empty;

        if (colName == KetQuaGC.KQGCDBName.SPID)
        {
            value = SQLServerServices.GetMaSanphamByID(id);
        }
        else if (colName == KetQuaGC.KQGCDBName.NCID)
        {
            value = SQLServerServices.GetNguyenCongByID(id);
        }
        else if (colName == KetQuaGC.KQGCDBName.MMID)
        {
            value = SQLServerServices.GetMaMayMocbyID(id);
        }
        else if (colName == KetQuaGC.KQGCDBName.NVIDs)
        {
            string ids = id?.ToString()?.Trim() ?? string.Empty;

            if (!string.IsNullOrEmpty(ids))
            {
                List<string> nvids = ids.Split(",").ToList();

                value = string.Join(", ", nvids
                        .Select(nvid => (SQLServerServices.GetNhanVienbyID(nvid).GetThongTinNhanVienByName("Tên nhân viên")).GiaTri.Value?.ToString() ?? string.Empty)
                        .Where(name => !string.IsNullOrEmpty(name)))
                        .Trim(',');
            }
        }
        else if (colName == KetQuaGC.KQGCDBName.NGIDs)
        {
            string ids = id?.ToString()?.Trim() ?? string.Empty;

            if (!string.IsNullOrEmpty(ids))
            {
                List<string> ngids = ids.Split(",").ToList();

                value = string.Join(", ", ngids
                        .Select(ngid => SQLServerServices.GetNoiDungNGbyID(ngid))
                        .Where(name => !string.IsNullOrEmpty(name)))
                        .Trim(',');
            }
        }

        return value;
    }

    #region Main Column Filtering
    // Khoi tao bien luu danh sach key search
    private async Task CreateCurrentSelectedKeyVariable()
    {
        await Task.Run(() =>
        {
            // Get main key colum
            List<Propertyy> columns = KetQuaGC.GetClassProperties() ?? new();
            foreach (var column in columns)
            {
                string key = column.DBName ?? string.Empty;
                if (key != string.Empty && !keyFilterMainColumns.ContainsKey(key))
                {
                    keyFilterMainColumns.Add(key, new());
                }
            }
        });
    }

    // Lay danh sach key search Main column
    private List<string> GetMainColumnKeysSearch(string targetColumn)
    {
        List<string> keys = new();

        if (targetColumn == KetQuaGC.KQGCDBName.SPID || targetColumn == KetQuaGC.KQGCDBName.MMID || targetColumn == KetQuaGC.KQGCDBName.NCID || targetColumn == KetQuaGC.KQGCDBName.NVIDs || targetColumn == KetQuaGC.KQGCDBName.NGIDs)
        {
            // Convert ID to stringValue
            keys = DSachKetQuaGCsBase
            .Select(nv => GetColumnValueByID(nv.GetPropertyValue(targetColumn), targetColumn) ?? string.Empty)
            .Where(result => !string.IsNullOrEmpty(result)).Distinct()
            .ToList();
        }
        else
        {
            keys = DSachKetQuaGCsBase
            .Select(nv => nv.GetPropertyValue(targetColumn)?.ToString() ?? string.Empty)
            .Where(result => !string.IsNullOrEmpty(result)).Distinct()
            .ToList();
        }

        return keys;
    }

    // Update selected Main column key
    private async Task OnComboboxMainColumnSelectedChanged(IEnumerable<string> values, string targetColumn)
    {
        if (values != null)
        {
            keyFilterMainColumns[targetColumn] = values.ToList();
        }
        else
        {
            keyFilterMainColumns[targetColumn] = new();
        }

        await FilterDSachKetQuaGCProcessing();
    }

    // Filtering processing
    private async Task FilterDSachKetQuaGCProcessing()
    {
        await Task.Run(() =>
        {
            DSachKetQuaGCs = DSachKetQuaGCsBase.ToList();

            // Main column filtering
            foreach (var column in keyFilterMainColumns)
            {
                List<string> selectedkeys = column.Value;

                if (selectedkeys != null && selectedkeys.Count > 0)
                {
                    if (column.Key == KetQuaGC.KQGCDBName.SPID || column.Key == KetQuaGC.KQGCDBName.MMID || column.Key == KetQuaGC.KQGCDBName.NCID || column.Key == KetQuaGC.KQGCDBName.NVIDs || column.Key == KetQuaGC.KQGCDBName.NGIDs)
                    {
                        // Convert ID to stringValue
                        DSachKetQuaGCs = DSachKetQuaGCs
                            .Where(nv =>
                            {
                                var value = nv.GetPropertyValue(column.Key);
                                var valueString = GetColumnValueByID(value, column.Key);
                                return valueString != null && selectedkeys.Contains(valueString);
                            }).ToList();
                    }
                    else
                    {
                        DSachKetQuaGCs = DSachKetQuaGCs
                            .Where(nv =>
                            {
                                var value = nv.GetPropertyValue(column.Key);
                                var valueString = value?.ToString();
                                return valueString != null && selectedkeys.Contains(valueString);
                            }).ToList();
                    }
                }
            }
        });
    }
    #endregion

    // Load all danh sach KQGC base
    private async Task LoadAllDanhsachKQGCBase(int delay)
    {
        await Task.Run(async () =>
        {
            if (isLoadingKQGCs == false)
            {
                isLoadingKQGCs = true;

                (DSachKetQuaGCsBase, string resultMess) = SQLServerServices.GetListKetQuaGC(); // load dach mac dinh

                foreach (var ketQuaGC in DSachKetQuaGCsBase)
                {
                    if (DateTime.TryParse(ketQuaGC.SubMitDay.Value?.ToString(), out DateTime submitday))
                    {
                        ketQuaGC.SubMitDay.Value = submitday.Date.ToShortDateString();
                    }
                }

                DSachKetQuaGCs = DSachKetQuaGCsBase.ToList(); // gan cho ds hien thi

                await Task.Delay(delay);

                isLoadingKQGCs = false;
            }
        });
    }

    // Them ket qua gia cong
    private async Task OnThemMoiKetQuaGC()
    {
        object newKetQuaGCid = await DialogService.OpenAsync<DialogAddNewKetQuaGC>(null, null,
        new DialogOptions() { ShowTitle = true, Width = "50%", Height = "95%", Resizable = true, Draggable = true, ShowClose = false, Style = "background-color: while; border-radius: 0px; padding: 0px" });

        await LoadAllDanhsachKQGCBase(300);

        if (newKetQuaGCid != null)
        {
            Common.SelectedKQGCid = newKetQuaGCid;

            ShowNotification("Reload success!", NotificationSeverity.Success, 2000);
        }
    }

    // Notification
    void ShowNotification(string message, NotificationSeverity notifytype, double time)
    {
        NotificationMessage notify = new NotificationMessage
            {
                Style = "position: fixed; top: 0; right: 0;",
                Severity = notifytype,
                Summary = message,
                Duration = time
            };

        NotificationService.Notify(notify);
    }

    // Datagrid selected changed event
    private void OnDatagridSelectChanged(IList<KetQuaGC> selectedKQGC)
    {
        DatagridSeleted = selectedKQGC;

        var fistItemSelectedkqgc = DatagridSeleted.FirstOrDefault();

        if (fistItemSelectedkqgc != null)
        {
            SelectedKQGC = fistItemSelectedkqgc;

            Common.SelectedKQGCid = fistItemSelectedkqgc.KQGCID.Value;
        }
    }

    // Datagrid cellrender
    private void OnCellRender(DataGridCellRenderEventArgs<KetQuaGC> args)
    {
        if (args.Column.Property.Contains("ID"))
        {
            args.Attributes.Add("style", $"font-weight: bold;");
        }
    }
}
