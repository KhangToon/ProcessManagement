@using ProcessManagement.Commons
@using ProcessManagement.Models.KHO_NVL
@using ProcessManagement.Models.KHO_TPHAM
@using ProcessManagement.Models.KHSXs
@using ProcessManagement.Pages.Kho_ThanhPham.ViTriLuuTru
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject SQLServerServices SQLServerServices
@inject TooltipService TooltipService

<RadzenCard Style="height: contain; width: 100%; border-radius: 10px" Variant="Variant.Flat">
    <RadzenStack Gap="0" Style="height: 100%; width: 100%;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
        <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.SpaceBetween">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="height: 5%; width: 100%; ">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 5%; width: contain; padding-bottom: 10px">
                    <RadzenText Text="@($"Kế hoạch sản xuất")" Style="font-size: 18px; font-weight: 600;"></RadzenText>
                    <RadzenText Text="@($"{TargetKHSX.MaLSX.Value?.ToString()}")" Style="font-size: 18px; font-weight: 600; color: darkblue"></RadzenText>
                </RadzenStack>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="5px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 5%; width: contain;">
                    <RadzenText Text="@($"Sản phẩm")" Style="font-size: 18px; font-weight: 600;"></RadzenText>
                    <RadzenText Text="@($"{TargetKHSX.TargetSanPham?.SP_MaSP.Value?.ToString()}")" Style="font-size: 18px; font-weight: 600; color: darkblue"></RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenStack>

        <RadzenRow Gap="10px" Style="height: contain; width: 100%; border-radius: 10px; border-top: var(--rz-grid-cell-border); border-bottom: var(--rz-grid-cell-border); padding: 0;">
            <RadzenColumn Size="12" SizeMD="12" Style="height: contain; width: 100%; padding: 15px;">
                <RadzenCard Variant="Variant.Filled" Style="border-radius: 10px; height: contain">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Style="height: 5%; width: 100%; padding-bottom: 10px">
                        <RadzenText Text="@($"Danh sách thùng thành phẩm")" Style="font-size: 18px; font-weight: 600; color: darkred"></RadzenText>

                        <RadzenText Text="@($"Tổng: {ThungTPhamExtends.Count} (thùng)")" Style="font-size: 18px; font-weight: 600;"></RadzenText>

                        @{
                            int sumdanhapkho = ThungTPhamExtends.Sum(ttp => (ttp.DaNhapKho) ? 1 : 0);
                            if (sumdanhapkho == ThungTPhamExtends.Count())
                            {
                                <RadzenText Text="@($"Đã nhập kho: {sumdanhapkho} (thùng)")" Style="font-size: 18px; font-weight: 600; color: darkgreen"></RadzenText>
                            }
                            else
                            {
                                <RadzenText Text="@($"Đã nhập kho: {sumdanhapkho} (thùng)")" Style="font-size: 18px; font-weight: 600; color: red"></RadzenText>
                            }
                        }


                    </RadzenStack>
                    <RadzenStack Orientation="Orientation.Vertical" Gap="10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: contain; width: 100%;">
                        <RadzenCard Variant="Variant.Flat" Style="height: contain; max-height: 500px; width: 100%; padding: 10px; padding-right: 0; overflow-y: scroll">
                            <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                <RadzenDataList Style="height: contain; width: 100%;" PagerPosition="PagerPosition.Top" WrapItems="true" AllowPaging="false" Data="@ThungTPhamExtends" TItem="ThungTPhamExtend">
                                    <Template Context="thungtpham">
                                        <RadzenCard Style="width: contain; height: contain; padding: 0" Variant="Variant.Flat">
                                            <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenText Text="@($"Thùng {ThungTPhamExtends.IndexOf(thungtpham) + 1}")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                <RadzenButton Visible="@(!thungtpham.DaNhapKho)" Text="Nhập kho thành phẩm" Icon="download" Click="@(async() => await OnSelectViTriLuuKho(thungtpham))"
                                                              ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat" Shade="Shade.Light" Style="border-radius: 5px; --rz-icon-size: 16px;" />
                                                <RadzenButton Visible="@(thungtpham.DaNhapKho)" Text="Đã nhập kho" Icon="check" Click="@(async() => await OnSelectViTriLuuKho(thungtpham))"
                                                              MouseEnter="@(args => ShowToolTip(args, TooltipPosition.Bottom, "Nhấn để xem", 100, 1000))"
                                                              ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Variant="Variant.Flat" Shade="Shade.Dark" Style="border-radius: 5px; --rz-icon-size: 16px;" />
                                            </RadzenStack>
                                            <RadzenCard Style="width: 100%; height: contain; min-height: 210px" Variant="Variant.Filled">
                                                <RadzenStack Style="width: 100%; height: 100%; padding: 0" Orientation=Orientation.Vertical AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenCard Variant="@(Variant.Outlined)" Style="height: 100%; width: 100%; padding: 10px;">
                                                        <RadzenStack Style="width: 100%; height: 100%;" Gap="10px" Orientation=Orientation.Vertical AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                <RadzenStack Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                    <RadzenText Text="ID thùng" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                </RadzenStack>
                                                                <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                                    <RadzenButton Text="@($"{thungtpham.IDThung?.ToString()}")" Style="color: darkblue; font-weight: 700; font-size: 18px; min-width: 100px"
                                                                                  ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Variant="Variant.Flat" Shade="Shade.Lighter"></RadzenButton>
                                                                </RadzenStack>
                                                            </RadzenStack>

                                                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                                <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                    <RadzenText Text="Số lượng/thùng" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                </RadzenStack>
                                                                <RadzenStack Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                                    <RadzenText Text="@($"{thungtpham.ThungTPhams.Sum(ttp => int.TryParse(ttp.SoLuong.Value?.ToString(), out int sl)? sl: 0).ToString()} (PCS)")" Style="font-size: 17px; font-weight: 600; height: contain; color: darkred"></RadzenText>
                                                                </RadzenStack>
                                                            </RadzenStack>

                                                            <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style="height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                <RadzenStack Visible="false" Gap="0" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                    <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 5px; padding-right: 0px;">
                                                                        <RadzenStack Style="width: 100%; height: contain" Gap="0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenStack Style="width: 70%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                <RadzenText Text="Mã quản lý NVL" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                                            </RadzenStack>
                                                                            <RadzenStack Style="width: 30%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                <RadzenText Text="Số lượng" Style="color: black; font-size: 14px; font-weight: 600; height: contain;"></RadzenText>
                                                                            </RadzenStack>
                                                                        </RadzenStack>
                                                                    </RadzenCard>
                                                                </RadzenStack>

                                                                <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 90%; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                                    @foreach (var thung in thungtpham.ThungTPhams)
                                                                    {
                                                                        <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 5px; padding-right: 0px; background-color: white">
                                                                            <RadzenStack Style="width: 100%; height: 100%" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                <RadzenStack Style="width: 70%; height: contain; padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                    <RadzenText Text="@thung.MaQuanLyLot.Value?.ToString()" Style="color: darkblue; font-weight: 600; font-size: 14px"></RadzenText>
                                                                                </RadzenStack>
                                                                                <RadzenStack Gap="10px" Style="width: 30%; height: contain; border-left: var(--rz-grid-cell-border);" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                                    <RadzenText Text="@($"{thung.SoLuong.Value?.ToString()} PCS")" Style="font-size: 14px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                                </RadzenStack>
                                                                            </RadzenStack>
                                                                        </RadzenCard>
                                                                    }
                                                                </RadzenStack>
                                                            </RadzenStack>


                                                        </RadzenStack>
                                                    </RadzenCard>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenCard>
                                    </Template>
                                </RadzenDataList>
                            </RadzenStack>
                        </RadzenCard>

                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

    </RadzenStack>
</RadzenCard>
<RadzenStack Gap="10px" Style="height: contain; width: 100%; padding-top: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
    <RadzenButton Style="width: 120px; height: 80%;" Click="@(() => {DialogService.Close(null);})" Icon="close" Text="Thoát" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Lighter" Size="ButtonSize.Small" Variant="Variant.Flat" />
</RadzenStack>

@code {
    [Parameter]
    public KHSX TargetKHSX { get; set; } = new();

    private List<ThungTPhamExtend> ThungTPhamExtends = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDSachThungTPhams(TargetKHSX.KHSXID.Value);

        await base.OnInitializedAsync();
    }

    private async Task LoadDSachThungTPhams(object? khsxid)
    {
        await Task.Run(() =>
        {
            List<ThungTPham> thungTPhams = SQLServerServices.GetListThungTPhams(new Dictionary<string, object?>() { { KHSX_LOT.DBName.KHSXID, khsxid } }).thungTPhams;

            // Group the ThungTPham objects by IDThung
            var groupedResults = thungTPhams.Where(ttp => ttp.IDThung.Value != null)
                                            .GroupBy(ttp => ttp.IDThung.Value)
                                            .Select(group => new ThungTPhamExtend
                                                {
                                                    IDThung = group.Key,
                                                    ThungTPhams = group.ToList(),
                                                    Total = group.ToList().Sum(ttp => int.TryParse(ttp.SoLuong.Value?.ToString(), out int sl) ? sl : 0),
                                                    MaSanPham = SQLServerServices.GetMaSanphamByID(group.ToList().FirstOrDefault()?.SPID.Value),
                                                }).ToList();
            if (groupedResults != null)
            {
                foreach (var thung in groupedResults)
                {
                    foreach (var ttp in thung.ThungTPhams)
                    {
                        if (int.TryParse(ttp.VTofTPID.Value?.ToString(), out int vtid))
                        {
                            thung.DaNhapKho = vtid > 0;
                        }
                    }
                }

                ThungTPhamExtends = groupedResults;
            }
        });
    }

    private async Task OnSelectViTriLuuKho(ThungTPhamExtend thungTPhamExtend)
    {
        var results = await DialogService.OpenAsync<DialogChonViTriKhoTPham>(null, new Dictionary<string, object>() { { "TarGetThungTPhamEx", thungTPhamExtend }, { "TargetKHSX", TargetKHSX } },
        new DialogOptions() { ShowTitle = true, Width = "90%", Height = "90%", Resizable = true, Draggable = true, ShowClose = false, Style = "background-color: while; border-radius: 10px; padding: 0px" });

        await LoadDSachThungTPhams(TargetKHSX.KHSXID.Value);
    }

    // Tooltip
    void ShowToolTip(ElementReference elementReference, TooltipPosition position, string content, int delay, int duration = 500)
    {
        TooltipOptions options = new TooltipOptions() { Position = position, Delay = delay, Duration = duration, Style = "background-color: black" };

        TooltipService.Open(elementReference, content, options);
    }
}
