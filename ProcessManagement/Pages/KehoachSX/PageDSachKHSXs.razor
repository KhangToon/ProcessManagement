@page "/pagedskhsanxuats"
@attribute [Authorize(Roles = "Admin")]
@* this limited access into page *@

@using ProcessManagement.Commons
@using ProcessManagement.Models
@using ProcessManagement.Models.TienDoGCs
@using ProcessManagement.Pages.KehoachSX.Dialogs
@using ProcessManagement.Pages.KehoachSX.KQGCs
@using ProcessManagement.Pages.KehoachSX.TienDos
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen

@inject NotificationService NotificationService
@inject TooltipService TooltipService
@inject ContextMenuService ContextMenuService
@inject DialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SQLServerServices SQLServerServices
@inject IJSRuntime JSRuntime

<style>
    .khsx_IsSelected {
        border-style: solid;
        border-width: 2px;
        border-color: green;
    }
</style>

<RadzenCard Variant="Variant.Flat" Style="height: 100%; width: 100%; padding: 10px;">
    <RadzenStack Gap="5" Style="height: 100%; width: 100%;">
        <RadzenStack Style="height: contain; width: 100%; padding-bottom: 5px; padding-left: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
            <RadzenStack Style="height: 100%; width: 20%; border-radius: 10px; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="DANH SÁCH KẾ HOẠCH SẢN XUẤT" Style="color: green; font-weight: 600; font-size: 18px"></RadzenText>
            </RadzenStack>
            <RadzenStack Gap="15px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Style="height: 100%; width: 60%;">
                <RadzenTextBox Placeholder="Nhập mã kế hoạch sản xuất để tìm kiếm" Style="border-radius: 20px; padding-left: 20px; border-width: 2px; border-color: var(--rz-primary-light); width: 50% "></RadzenTextBox>
                <RadzenButton Icon="search" ButtonStyle="ButtonStyle.Primary" Style="border-radius: 20px;" />
                <RadzenButton Style="border-radius: 20px;" Icon="autorenew" ButtonStyle="ButtonStyle.Primary" />
            </RadzenStack>
        </RadzenStack>

        <RadzenRow Gap="0px" Style="height: 100%; width: 100%; border-top: var(--rz-grid-cell-border); padding: 0;">
            <RadzenColumn Style="height: contain; border-right: var(--rz-grid-cell-border)">
                <RadzenStack Gap="0px" Style="height: contain; width: contain" Orientation="Orientation.Vertical" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                    <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding: 10px; padding-left: 10px; border-bottom: var(--rz-grid-cell-border) " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenStack Visible="@isExpandListKHSX">
                            <RadzenText Text="Danh sách kế hoạch sản xuất" Style="color: darkred; font-weight: 600; font-size: 17px; height: contain; width: contain; font-style: italic;"></RadzenText>
                        </RadzenStack>
                        <RadzenButton Click="@(() => isExpandListKHSX = !isExpandListKHSX)" Icon="@((isExpandListKHSX)? "arrow_back" : "arrow_forward")" Size="ButtonSize.Small"
                                      ButtonStyle="ButtonStyle.Primary" Variant="Variant.Flat" Shade="Shade.Darker"
                                      Style="font-size: 14px; border-radius: 0px;" />
                    </RadzenStack>
                    <RadzenStack Gap="10px" Style="height: contain; width: 100%;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenDataList Style="height: contain; width: 100%;" PagerPosition="PagerPosition.Top" PageSize="10" WrapItems="true" AllowPaging="true" Data="@DSKHSXs" TItem="KHSX">
                            <Template Context="khsx">
                                <RadzenCard onclick="@(async() => await OnKHSXClick(khsx))" Style="width: 100%; height: contain; padding: 0; cursor: pointer" Variant="Variant.Flat">
                                    <RadzenCard class="@(IsKHSXSelected(khsx))" Style="width: 100%; height: contain; padding: 10px" Variant="Variant.Filled">
                                        <RadzenStack Style="width: 100%; height: 100%; padding: 0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenCard Variant="@((khsx.KHSXID.Value?.Equals(SelectedKHSX.KHSXID.Value)?? false)? Variant.Flat : Variant.Outlined)" Style="height: 100%; width: 100%; padding: 15px;">
                                                <RadzenStack Style="width: 100%; height: 100%;" Gap="10px" Orientation=Orientation.Vertical AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                    <RadzenStack Visible="@isExpandListKHSX" Gap="0" Style="width: 100%; height: contain; padding-bottom: 5px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Style="height: contain; width: contain; min-width: 30px; border-radius: 5px; background-color: var(--rz-primary-lighter); padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                            <RadzenText Text="@((DSKHSXs.IndexOf(khsx) + 1).ToString())" Style="color: rgba(58,71,77); font-weight: 600; font-size: 15px"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="height: contain; width: contain; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                            @if (khsx.IsDoneKHSX)
                                                            {
                                                                <RadzenButton Text="Đã hoàn thành" Icon="check" ButtonStyle="ButtonStyle.Success" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Outlined"
                                                                              Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: 100%; cursor: default; background-color: rgb(229,245,233); font-weight: 600" />
                                                            }
                                                            else
                                                            {
                                                                <RadzenButton Text="Chưa hoàn thành" ButtonStyle="ButtonStyle.Warning" Size="ButtonSize.Small" Shade="Shade.Dark" Variant="Variant.Outlined"
                                                                              Style="border-radius: 5px; --rz-icon-size: 18px; height: 20px; width: 100%; cursor: default; background-color: rgb(254,243,220); font-weight: 600" />
                                                            }
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                    <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Visible="@isExpandListKHSX" Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenText Text="Mã KHSX" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                            <RadzenText Text="@($"{khsx.MaLSX.Value?.ToString()}")" Style="color: darkblue; font-weight: 700; font-size: 18px"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                    <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Visible="@isExpandListKHSX" Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenText Text="Sản phẩm" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                            <RadzenText Text="@($"{khsx.SanPham?.SP_MaSP.Value?.ToString()}")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                    <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Visible="@isExpandListKHSX" Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenText Text="Loại NVL" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                            <RadzenText Text="@($"{khsx.LoaiNVL?.TenLoaiNVL.Value?.ToString()}")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                    <RadzenStack Visible="@isExpandListKHSX" Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenText Text="Số lượng sản xuất" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                            <RadzenText Text="@($"{khsx.SLSanPhamSX.Value?.ToString()}")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                    <RadzenStack Visible="@isExpandListKHSX" Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                                        <RadzenStack Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                            <RadzenText Text="Số lượng Lot NVL" Style="font-size: 16px; font-weight: 500; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                                            <RadzenText Text="@($"{khsx.SLLot.Value?.ToString()}")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenStack>
                                    </RadzenCard>
                                </RadzenCard>
                            </Template>
                        </RadzenDataList>
                    </RadzenStack>

                    <RadzenStack Visible="@(DSKHSXs.Count == 0)" Gap="10px" Style="height: contain; width: 100%; padding: 10px; padding-left: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                        <RadzenText Text="Chưa có kế hoạch sản xuất nào" Style="color: red; font-weight: 600; font-size: 16px; height: contain; width: contain;"></RadzenText>
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeMD="@((isExpandListKHSX)? 9 : 10)" Style="height: contain; width: 100%; padding: 10px; ">
                <RadzenTabs Visible="@(khsxwaitloading == false)" Style="width: 100%" SelectedIndex="@selectedTabIndex">
                    <Tabs>
                        <RadzenTabsItem>
                            <Template>
                                <RadzenText Text="@($"THÔNG TIN KHSX - {SelectedKHSX.MaLSX.Value?.ToString()}")" Style="color: darkred; font-weight: 500; font-size: 15px"></RadzenText>
                            </Template>
                            <ChildContent>
                                <DialogDetailKHSX SelectKHSX="@SelectedKHSX" IsNotDialog="true"></DialogDetailKHSX>
                            </ChildContent>
                        </RadzenTabsItem>
                        <RadzenTabsItem>
                            <Template>
                                <RadzenText Text="DANH SÁCH LOT NVL" Style="color: darkred; font-weight: 500; font-size: 15px"></RadzenText>
                            </Template>
                            <ChildContent>
                                <DanhSachLotNVL TargetKHSX="@SelectedKHSX"></DanhSachLotNVL>
                            </ChildContent>
                        </RadzenTabsItem>

                        <RadzenTabsItem>
                            <Template>
                                <RadzenText Text="THEO DÕI SẢN XUẤT" Style="color: darkred; font-weight: 500; font-size: 15px;"></RadzenText>
                            </Template>
                            <ChildContent>
                                <TheoDoiSanXuat TargetKHSX="@SelectedKHSX"></TheoDoiSanXuat>
                            </ChildContent>
                        </RadzenTabsItem>

                        <RadzenTabsItem>
                            <Template>
                                <RadzenText Text="QUẢN LÝ CÔNG ĐOẠN" Style="color: darkred; font-weight: 500; font-size: 15px"></RadzenText>
                            </Template>
                        </RadzenTabsItem>
                    </Tabs>
                </RadzenTabs>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
</RadzenCard>


@code {
    private List<KHSX> DSKHSXs = new();
    private KHSX SelectedKHSX = new();
    private bool isSearching = false;
    private static int selectedTabIndex = 0;
    private static bool isExpandListKHSX = false;

    private static object? selectKHSXID;

    protected override async Task OnInitializedAsync()
    {
        await OnGetListKHSXs();

        if (DSKHSXs.Any())
        {
            if (selectKHSXID != null)
            {
                SelectedKHSX = DSKHSXs.FirstOrDefault(x => object.Equals(x.KHSXID.Value, selectKHSXID)) ?? new();
            }
            else SelectedKHSX = DSKHSXs.FirstOrDefault() ?? new();

        }

        await base.OnInitializedAsync();
    }


    private async Task OnGetListKHSXs()
    {
        DSKHSXs = await Task.Run(() =>
        {
            var results = SQLServerServices.GetListKHSXs();

            if (results.Any())
            {
                results.Reverse();
            }
            return results;
        });
    }

    private string IsKHSXSelected(KHSX selectKHSX)
    {
        if (SelectedKHSX.KHSXID.Value != null && SelectedKHSX.KHSXID.Value.Equals(selectKHSX.KHSXID.Value))
        {
            return "khsx_IsSelected";
        }
        else return string.Empty;
    }

    private bool khsxwaitloading = false;
    private async Task OnKHSXClick(KHSX selectKHSX)
    {
        SelectedKHSX = selectKHSX;

        selectKHSXID = selectKHSX.KHSXID.Value;

        //Common.CurrentKHSXid = SelectedKHSX.KHSXID.Value;


        khsxwaitloading = true;
        StateHasChanged();
        await Task.Delay(50);
        khsxwaitloading = false;
        StateHasChanged();
    }
}
