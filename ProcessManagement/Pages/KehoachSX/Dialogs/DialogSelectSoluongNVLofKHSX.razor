@using ProcessManagement.Commons
@using ProcessManagement.Models.KHO_NVL
@using ProcessManagement.Models.SANPHAM
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject TooltipService TooltipService
@inject SQLServerServices SQLServerServices

<RadzenCard Variant="Variant.Filled" Style="height: 100%; width: 100%; padding: 10px;">
    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 100%; width: 100%; padding: 0px; padding-bottom: 10px " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
        <RadzenStack Gap="20px" Style="height: contain; width: 100%; padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
            <RadzenText Text="Chỉ định số lượng nguyên liệu sản xuất" Style="color: darkgreen; font-weight: 600; font-size: 18px"></RadzenText>
            <RadzenText Text="@($"{selectSanPham.SP_TenSanPham.Value?.ToString()} ({selectSanPham.SP_MaSP.Value?.ToString()})")" Style="color: darkblue; font-weight: 600; font-size: 18px; font-style: italic"></RadzenText>
        </RadzenStack>

        <!--Chi dinh so luong san pham-->
        <RadzenStack Gap="20px" Style="height: contain; width: 100%; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
            <!--Loai NVL-->
            <RadzenStack Gap="10px" Style="width: contain; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Loại nguyên liệu" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                <RadzenDropDown AllowFiltering="true" AllowClear="true" Placeholder="* chọn loại nguyên liệu" Disabled="(DsachloaiNVLs?.Count == 0 || DsachloaiNVLs == null)" TValue="string" Style="width: 100%; height: contain; font-size: 14px; font-weight: 600"
                                Value="selectLoaiNVL?.TenLoaiNVL.Value?.ToString()"
                                Data=@(DsachloaiNVLs?.Select(lnvl => lnvl.TenLoaiNVL.Value?.ToString()?.Trim()) ?? Enumerable.Empty<string>())
                                Change="@(args =>
                                        {
                                            selectLoaiNVL = DsachloaiNVLs?.FirstOrDefault(lnvl => lnvl.TenLoaiNVL.Value?.ToString()?.Trim() == args?.ToString());
                                            DsachNVLs = LoadListNguyenVatLieu(selectLoaiNVL);
                                            selectNguyenVL = null; // reset selected NVL
                                            selectSanPham = new(); // reset selected SP
                                            DsachSPs = new(); // reset dsach SP
                                            generLot.NewKHSX.TargetSanPham = null;
                                            generLot.NewKHSX.TargetNVL = null;
                                        })">
                </RadzenDropDown>
            </RadzenStack>

            <!--Ten NVL-->
            <RadzenStack Gap="10px" Style="width: contain; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Tên nguyên liệu" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                <RadzenDropDown AllowFiltering="true" AllowClear="true" Placeholder="* chọn nguyên liệu" Disabled="(DsachNVLs?.Count == 0 || DsachNVLs == null)" TValue="string" Style="width: 100%; height: contain; font-size: 14px; font-weight: 600"
                                Value="selectNguyenVL?.TenNVL.Value?.ToString()"
                                Data=@(DsachNVLs?.Select(nvl => nvl.TenNVL.Value?.ToString()?.Trim()) ?? Enumerable.Empty<string>())
                                Change="@(args =>
                                        {
                                            selectNguyenVL = DsachNVLs?.FirstOrDefault(nvl => nvl.TenNVL.Value?.ToString()?.Trim() == args?.ToString());
                                            DsachSPs = LoadDSachSanPham(selectNguyenVL);
                                            selectSanPham = new(); // reset selected SanPham
                                            generLot.NewKHSX.TargetSanPham = null;
                                            generLot.NewKHSX.TargetNVL = null;
                                        })">
                </RadzenDropDown>
            </RadzenStack>

            <!--Loai SP-->
            <RadzenStack Gap="10px" Style="width: contain; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Chỉ định sản phẩm" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                <RadzenDropDown AllowFiltering="true" AllowClear="true" Placeholder="* chọn sản phẩm" Disabled="(DsachSPs?.Count == 0 || DsachSPs == null)" TValue="string" Style="width: 100%; height: contain; font-size: 14px; font-weight: 600"
                                Value="selectSanPham?.SP_MaSP.Value?.ToString()"
                                Data=@(DsachSPs?.Select(sp => sp.SP_MaSP.Value?.ToString()?.Trim()) ?? Enumerable.Empty<string>())
                                Change="@(args =>
                                        {
                                            selectSanPham = DsachSPs?.FirstOrDefault(sp => sp.SP_MaSP.Value?.ToString()?.Trim() == args?.ToString()?.Trim()) ?? new();
                                            generLot.isGenerateListLotOK = false;
                                            generLot.isCheckSLNVLisOK = false;
                                            generLot.ResetDefault();
                                        })">
                </RadzenDropDown>
            </RadzenStack>

            <!--So luong san xuat-->
            <RadzenStack Gap="10px" Style="width: contain; height: contain;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Số lượng cần sản xuất" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                <RadzenNumeric TValue="int" TextAlign=TextAlign.Center
                               Min="0" Max="999999"
                               Value="@(generLot.SLSanPhamSX)"
                               ValueChanged="@((args) => { OnNumOfSanPhamChanged(args); })"
                               Style="--rz-input-font-size: 18px; font-weight: 600; height: 35px; border-width: 1px; width: contain" />
            </RadzenStack>
        </RadzenStack>

        <RadzenRow Gap="10px" Style="width: 100%; height: 100%;">
            <!--Danh sach nguyen lieu cua san pham-->
            <RadzenColumn Size="12" SizeMD="12" Style="width: 100%; height: 100%; padding-right: 10px; border-right: var(--rz-grid-cell-border)">
                <!--Danh sach nguyen lieu cua san pham-->
                <RadzenStack Visible="@(selectSanPham.DanhSachNVLs.Count > 0)" Style="height: 100%; width: 100%; padding: 5px; padding-left: 10px; padding-right: 10px;" Gap="5px" Orientation="Orientation.Vertical">
                    <RadzenStack Style="width: 100%; height: contain; padding: 0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenCard Variant="Variant.Outlined" Style="height: contain; width: 100%; padding: 10px; padding-right: 0; margin-bottom: 10px">
                            <RadzenStack Gap="5px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; padding: 0px;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                <RadzenStack Gap="20px" Style="height: contain; width: 100%; padding: 5px; padding-top: 0px; padding-left: 0px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                    <RadzenText Text="Danh sách nguyên liệu của sản phẩm" Style="color: black; font-weight: 500; font-size: 16px"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Gap="5px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; max-height: 250px; padding-right: 0; overflow-y: scroll" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                    <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: contain; padding: 5px; padding-right: 0px; background-color: rgb(58, 71, 77)">
                                        <RadzenStack Style="width: 100%; height: contain; " Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenStack Style="width: 3%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="#" Style="color: white; font-weight: 500; font-size: 14px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Tên NVL" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Loại NVL" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Tồn kho" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="NVL/1SP" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Số lượng PO" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Tỉ lệ lỗi cho phép (%)" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 15%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Số lượng NVL" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 10%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="Chi tiết" Style="color: white; font-weight: 500; font-size: 16px"></RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenCard>

                                    @foreach (var nvlofsp in selectSanPham.DanhSachNVLs)
                                    {
                                        <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 0px; padding-top: 5px; padding-bottom: 5px; background-color: white">
                                            <RadzenStack Style="width: 100%; height: contain" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                <RadzenStack Style="width: 3%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="@($"{(selectSanPham.DanhSachNVLs.IndexOf(nvlofsp) + 1).ToString()}")" Style="color: gray; font-weight: 600; font-size: 14px"></RadzenText>
                                                </RadzenStack>

                                                <!--Ten NVL-->
                                                <RadzenStack Style="width: 15%; height: contain; border-left: var(--rz-grid-cell-border); border-right: var(--rz-grid-cell-border); padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        <RadzenText Text="@($"{nvlofsp.TargetNgLieu.TenNVL.Value?.ToString()}")" Style="color: darkblue; font-weight: 600; font-size: 15px"></RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--Loai NVL-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        <RadzenText Text="@($"{nvlofsp.TargetNgLieu.LoaiNVL?.TenLoaiNVL.Value?.ToString()}")" Style="color: black; font-weight: 600; font-size: 15px"></RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--Ton kho-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        @{
                                                            int tonkho = nvlofsp.TargetNgLieu.TonKho;
                                                            if (tonkho == 0)
                                                            {
                                                                <RadzenText Text="@($"{nvlofsp.TargetNgLieu.TonKho} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: red; font-weight: 600; font-size: 16px"></RadzenText>

                                                            }
                                                            else
                                                            {
                                                                <RadzenText Text="@($"{nvlofsp.TargetNgLieu.TonKho} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                                                            }
                                                        }
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--Quy cach-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        <RadzenText Text="@($"{nvlofsp.QuyCach.Value?.ToString()} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--So luong SX-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">

                                                        @if (!nvlofsp.isEditingSoluong)
                                                        {
                                                            if (nvlofsp.TargetNgLieu.TonKho == 0 || nvlofsp.allsoLuongcanLay > nvlofsp.TargetNgLieu.TonKho || nvlofsp.allsoLuongcanLay == 0)
                                                            {
                                                                <RadzenText Text="@($"{(nvlofsp.allsoLuongcanLay)} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: red; font-weight: 600; font-size: 16px"></RadzenText>
                                                            }
                                                            else
                                                            {
                                                                <RadzenText Text="@($"{(nvlofsp.allsoLuongcanLay)} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <RadzenNumeric TValue="int" TextAlign=TextAlign.Center
                                                                           Min="0" Max="999999"
                                                                           Value="@(nvlofsp.allsoLuongcanLay)"
                                                                           ValueChanged="@((args) => { nvlofsp.allsoLuongcanLay = args; })"
                                                                           Style="--rz-input-font-size: 16px; color: red; font-weight: 600; height: 35px; border-width: 1px; width: contain;" />
                                                        }

                                                        <RadzenButton Visible="false" Icon="@((nvlofsp.isEditingSoluong)? "check" : "edit")" Variant="@((nvlofsp.isEditingSoluong)? Variant.Flat : Variant.Text)"
                                                                      Click="(() => {nvlofsp.isEditingSoluong = !nvlofsp.isEditingSoluong;})"
                                                                      ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" Shade="@((nvlofsp.isEditingSoluong)? Shade.Lighter : Shade.Darker)" Style="border-radius: 5px; --rz-icon-size: 18px; height: 35px; width: 35px" />
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--Ti le loi-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                        <RadzenNumeric Visible="false" TValue="int" TextAlign=TextAlign.Center
                                                                       Min="0" Max="999999"
                                                                       Value="@(nvlofsp.slloichophep)" Step="1"
                                                                       ValueChanged="@((args) => { nvlofsp.slloichophep = args; GetDinhMucSX(nvlofsp);})"
                                                                       Style="--rz-input-font-size: 16px; color: red; font-weight: 600; height: 35px; border-width: 1px; width: 80%;" />

                                                        <RadzenNumeric TValue="double" TextAlign=TextAlign.Center
                                                                       Min="0" Max="100"
                                                                       Value="@(nvlofsp.tileloi)" Step="0.1"
                                                                       ValueChanged="@((args) => { nvlofsp.tileloi = args; GetDinhMucSX(nvlofsp);})"
                                                                       Style="--rz-input-font-size: 16px; color: red; font-weight: 600; height: 35px; border-width: 1px; width: 80%;" />

                                                        <RadzenText Visible="false" Text="@($"{nvlofsp.tileloi} (%)")" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <!--Dinh muc-->
                                                <RadzenStack Style="width: 15%; height: contain; border-right: var(--rz-grid-cell-border); padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenStack Style="height: contain; min-height: 35px; width: 100%; border-radius: 5px; padding: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        @if (nvlofsp.TargetNgLieu.TonKho == 0 || nvlofsp.allsoLuongcanLay > nvlofsp.TargetNgLieu.TonKho || nvlofsp.dinhmuc > nvlofsp.TargetNgLieu.TonKho || nvlofsp.allsoLuongcanLay == 0)
                                                        {
                                                            <RadzenText Text="@($"{nvlofsp.dinhmuc} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: red; font-weight: 600; font-size: 18px"></RadzenText>
                                                        }
                                                        else
                                                        {
                                                            <RadzenText Text="@($"{nvlofsp.dinhmuc} ({nvlofsp.TargetNgLieu.DonViTinh.Value?.ToString()})")" Style="color: darkgreen; font-weight: 600; font-size: 18px"></RadzenText>
                                                        }
                                                    </RadzenStack>
                                                </RadzenStack>

                                                <RadzenStack Style="width: 10%; height: contain; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="(Chi tiết)" @onclick="@(() => OnOpenDialogXemChitietNVL(nvlofsp.TargetNgLieu))" Style="font-size: 14px; font-weight: 600; height: contain; color: Highlight; font-style: italic; cursor: pointer"></RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenCard>
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </RadzenCard>
                    </RadzenStack>
                </RadzenStack>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
    <RadzenStack Gap="10px" Style="height: contain; width: 100%; padding-top: 10px; border-top: var(--rz-grid-cell-border) " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
        <RadzenButton Disabled="@(!IsAllowXacNhan())" Style="width: 120px;" Icon="check" Text="Xác nhận" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Dark" Variant="Variant.Flat" Click="@(() => OnXacNhan())" />
        <RadzenButton Style="width: 120px;" Icon="close" Text="Thoát" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Dark" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => DialogService.Close(null))" />
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter]
    public GenerateLot generLot { get; set; } = new();

    private List<DanhMucNVL>? DsachDanhmucNVL;
    private DanhMucNVL? SelectDanhmuc;

    private List<LoaiNVL>? DsachloaiNVLs;
    private LoaiNVL? selectLoaiNVL;

    private List<NguyenVatLieu>? DsachNVLs;
    private NguyenVatLieu? selectNguyenVL;

    private List<SanPham>? DsachSPs = new();
    private SanPham selectSanPham = new();

    protected override Task OnInitializedAsync()
    {
        DsachDanhmucNVL = LoadListDanhmucNguyenVatLieu();

        SelectDanhmuc = DsachDanhmucNVL?.FirstOrDefault(dm => dm.TenDanhMuc.Value?.ToString()?.Trim() == Common.DanhMucNguyenLieuGiaCong);

        DsachloaiNVLs = LoadListLoaiNguyenVatLieu(SelectDanhmuc);

        if (!string.IsNullOrEmpty(generLot.NewKHSX.TargetNVL?.NVLID.Value?.ToString()))
        {
            selectNguyenVL = generLot.NewKHSX.TargetNVL ?? new();

            selectLoaiNVL = selectNguyenVL.LoaiNVL;

            DsachNVLs = LoadListNguyenVatLieu(selectLoaiNVL);

            selectNguyenVL.DSachSPofNVLs = SQLServerServices.GetDSachNVLwithSanPham_byNVLID(selectNguyenVL.NVLID.Value);

            if (!string.IsNullOrEmpty(generLot.NewKHSX.TargetSanPham?.SP_SPID.Value?.ToString()))
            {
                selectSanPham = generLot.NewKHSX.TargetSanPham ?? new();

                DsachSPs = LoadDSachSanPham(selectNguyenVL);
            }
        }

        return base.OnInitializedAsync();
    }

    // Load danh sach danh muc NVL
    private List<DanhMucNVL>? LoadListDanhmucNguyenVatLieu()
    {
        var danhmucs = SQLServerServices.GetListDanhMucNVLs();

        return danhmucs;
    }

    // Load danh sach loai NVL
    private List<LoaiNVL>? LoadListLoaiNguyenVatLieu(DanhMucNVL? selectedresult)
    {
        int danhmucID = int.TryParse(selectedresult?.DMID?.Value?.ToString(), out int dmid) ? dmid : 0;

        var loaiNVLs = SQLServerServices.GetListLoaiNVLs(danhmucID);

        return loaiNVLs;
    }

    // Load danh sach NVL
    private List<NguyenVatLieu>? LoadListNguyenVatLieu(LoaiNVL? selectedresult)
    {
        int loaiNVLID = int.TryParse(selectedresult?.LOAINVLID?.Value?.ToString(), out int lnvlid) ? lnvlid : 0;

        var nguyenlieus = SQLServerServices.GetListNguyenVatLieuByLoaiNvlID(loaiNVLID);

        return nguyenlieus;
    }

    // Load danh sach SanPham
    private List<SanPham>? LoadDSachSanPham(NguyenVatLieu? selectednvl)
    {
        List<SanPham> sanPhams = new();

        if (selectednvl != null)
        {
            selectednvl.DSachSPofNVLs = SQLServerServices.GetDSachNVLwithSanPham_byNVLID(selectednvl.NVLID.Value);

            foreach (var spofnvl in selectednvl.DSachSPofNVLs)
            {
                spofnvl.TargetSP = SQLServerServices.GetSanpham(int.TryParse(spofnvl.SPID.Value?.ToString(), out int spid) ? spid : 0);

                sanPhams.Add(spofnvl.TargetSP);
            }
        }

        return sanPhams;
    }

    public List<string> GetDSMaSPs(List<SanPham>? sanPhams)
    {
        List<string> result = sanPhams?.Select(sp => sp.SP_MaSP.Value?.ToString() ?? string.Empty).ToList() ?? new();

        return result;
    }

    // Soluong san pham changed
    private void OnNumOfSanPhamChanged(int args)
    {
        // Update SL Sanpham can SX
        generLot.SLSanPhamSX = args;

        foreach (var nvlofsp in selectSanPham.DanhSachNVLs)
        {
            bool iscanconvert = int.TryParse(nvlofsp.QuyCach.Value?.ToString(), out int slforsp);

            if (iscanconvert)
            {
                // Update so luong can lay cua moi NVL
                nvlofsp.allsoLuongcanLay = generLot.SLSanPhamSX * slforsp;
                // Tinh dinh muc/ti le loi
                GetDinhMucSX(nvlofsp);
            }
            else { nvlofsp.allsoLuongcanLay = 0; }
        }
    }

    // Tinh Dinh muc san xuat
    public void GetDinhMucSX(NVLwithSanPham nVLofsp)
    {
        int slloi = (int)Math.Round(nVLofsp.allsoLuongcanLay * (nVLofsp.tileloi / 100), MidpointRounding.AwayFromZero); // lam tron len neu > 0.5

        // tinh tileloi
        //double tileloi = Math.Round(((double)nVLofsp.slloichophep / nVLofsp.allsoLuongcanLay) * 100, 1);
        // gan tileloi
        //nVLofsp.tileloi = tileloi;
        nVLofsp.slloichophep = slloi;

        // gan dinh muc
        if (nVLofsp.tileloi > 0)
        {
            nVLofsp.dinhmuc = nVLofsp.allsoLuongcanLay + nVLofsp.slloichophep;
        }
        else nVLofsp.dinhmuc = nVLofsp.allsoLuongcanLay;
    }

    // Dialog xem chi tiet NVL
    private async Task OnOpenDialogXemChitietNVL(NguyenVatLieu nguyenVatLieu)
    {
        await DialogService.OpenAsync<Manager_NVL.Dialogs.DialogDetailsNguyenVatLieu>(null, new Dictionary<string, object>() { { "NgVLieu", nguyenVatLieu } },
        new DialogOptions() { ShowTitle = false, Width = "50%", Height = "contain", Resizable = false, Draggable = false, ShowClose = false, Style = "background-color: while; border-radius: 10px; padding: 0px" });
    }

    // Kiem tra hop le so luong NVL
    private bool IsAllowXacNhan()
    {
        bool isallow = true;

        foreach (var nvlofsp in selectSanPham.DanhSachNVLs)
        {
            if (nvlofsp.TargetNgLieu.TonKho == 0 || nvlofsp.allsoLuongcanLay > nvlofsp.TargetNgLieu.TonKho || nvlofsp.dinhmuc > nvlofsp.TargetNgLieu.TonKho || nvlofsp.allsoLuongcanLay == 0)
            {
                isallow = false; break;
            }
        }

        if (generLot.SLSanPhamSX == 0)
        {
            isallow = false;
        }

        return isallow;
    }

    // Xac nhan so luong NVL can lay
    private void OnXacNhan()
    {
        if (selectSanPham.DanhSachNVLs != null)
        {
            generLot.NewKHSX.DSachNVLofKHSXs = new();

            foreach (var nvl in selectSanPham.DanhSachNVLs)
            {
                NVLofKHSX nVLofKHSX = new()
                    {
                        // asign KHSXID (after insert KHSX to DB)
                        ThoiDiem = { Value = DateTime.Now },
                        NVLID = { Value = nvl.NVLID.Value },
                        SPID = { Value = selectSanPham.SP_SPID.Value },
                        SoLuong = { Value = nvl.allsoLuongcanLay },
                        TiLeLoi = { Value = nvl.tileloi },
                        DinhMuc = { Value = nvl.dinhmuc }
                    };

                generLot.NewKHSX.DSachNVLofKHSXs?.Add(nVLofKHSX);
            }

            // Update so luong NVL da lay
            generLot.SLNgVatLieuSX = generLot.NewKHSX.DSachNVLofKHSXs?.Sum(item => int.Parse(item.SoLuong.Value?.ToString() ?? "0")) ?? 0;

            generLot.DinhMuc = generLot.NewKHSX.DSachNVLofKHSXs?.Sum(item => int.Parse(item.DinhMuc.Value?.ToString() ?? "0")) ?? 0;

            generLot.TiLeLoi = Math.Round(generLot.NewKHSX.DSachNVLofKHSXs?.Sum(item => double.Parse(item.TiLeLoi.Value?.ToString() ?? "0")) ?? 0, 4);
            //generate.TiLeLoi = Math.Round((((double)generate.DinhMuc - generate.SLNgVatLieuSX) / generate.SLNgVatLieuSX) * 100, 2);

            //
            generLot.NewKHSX.TargetNVL = selectNguyenVL ?? null;

            generLot.NewKHSX.TargetSanPham = selectSanPham ?? null;

            DialogService.Close(generLot.NewKHSX.DSachNVLofKHSXs);
        }
    }
}
