@using ProcessManagement.Commons
@using ProcessManagement.Models.KHO_NVL
@using ProcessManagement.Models.KHO_NVL.XuatKho
@using ProcessManagement.Pages.Manager_NVL.Dialogs
@using ProcessManagement.Pages.Manager_NguyenCong.Dialogs
@using ProcessManagement.Pages.Manager_SanPham.Dialogs
@using ProcessManagement.Services.SQLServer
@using Radzen.Blazor
@using Radzen
@using ProcessManagement.Models

@inject DialogService DialogService
@inject NotificationService NotificationService
@inject SQLServerServices SQLServerServices
@inject NavigationManager NavigationManager

<RadzenStack Gap="0" Style="width: 100%; height: contain; background-color: white" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
    <RadzenRow Style="width: 100%;">
        <RadzenColumn Size="12" SizeMD="4" Style="width: 100%; height: contain;">
            <RadzenStack Style="height: 100%; width: 100%; padding-right: 15px;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 15px; padding-top: 10px; border-radius: 10px;">
                    <RadzenStack Gap="0px" Style="width: 100%; height: 100%; padding: 0" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenStack Style="width: 100%; height: contain; border-bottom: var(--rz-grid-cell-border); padding-bottom: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                            <RadzenText Style="color: darkred; font-weight: 600; font-size: 16px; font-style: initial" Text="Thông tin kế hoạch sản xuất"></RadzenText>
                        </RadzenStack>
                        <RadzenStack Gap="10px" Style="width: 100%; height: contain; padding: 10px" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <!--LSX Code-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Mã lệnh SX" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                    <RadzenText Text="@SelectKHSX?.MaLSX.Value?.ToString()" Style="font-size: 16px; font-weight: 600; height: contain; color: red"></RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <!--Ngày tạo-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Ngày tạo" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.End">
                                    <RadzenText Text="@SelectKHSX?.NgayTao.Value?.ToString()" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <!--Ten SP-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Tên sản phẩm" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.End">
                                    <RadzenText Text="@SelectKHSX?.SanPham?.SP_TenSanPham.Value?.ToString()" Style="font-size: 16px; font-weight: 600; height: contain; color: darkblue"></RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <!--Số lượng Sản phẩm SX-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Số lượng PO" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                    <RadzenText Text="@($"{SelectKHSX?.SLSanPhamSX.Value?.ToString()} (SP)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <!--Tỉ lệ lỗi-->
                            <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    <RadzenText Text="Tỉ lệ lỗi" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                </RadzenStack>
                                <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                    <RadzenText Text="@($"{SelectKHSX?.TileLoi.Value?.ToString()} (%)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="10px" Style="width: 100%; height: contain; padding-top: 10px; padding-bottom: 10px; border-top: var(--rz-grid-cell-border); border-bottom: var(--rz-grid-cell-border)" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                <!--Định mức-->
                                <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Số lượng NVL sản xuất" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                        <RadzenText Text="@($"{SelectKHSX?.DinhMuc.Value?.ToString()} (PCS)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                    </RadzenStack>
                                </RadzenStack>

                                <!--Số Lot-->
                                <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Số lượng lot" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 55%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                        <RadzenText Text="@($"{SelectKHSX?.SLLot.Value?.ToString()} (LOT)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                    </RadzenStack>
                                </RadzenStack>

                                <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 45%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                    </RadzenStack>
                                    <RadzenStack Style="width: 55%; height: contain;" Gap="10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                        <RadzenText Text="@($"{SelectKHSX?.SLLotChan.Value} ({SelectKHSX?.SLperLotChan.Value} PCS) + {SelectKHSX?.SLLotLe.Value} ({SelectKHSX?.SLperLotLe.Value} PCS)")" Style="font-size: 16px; font-weight: 600; height: contain; color: black"></RadzenText>
                                    </RadzenStack>
                                </RadzenStack>

                                <!--Range ma quan ly-->
                                <RadzenStack Gap="0" Style="width: 100%; height: contain;" Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 100%; height: contain; padding-right: 10px" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Mã quản lý LOT" Style="font-size: 14px; font-weight: 700;"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 100%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
                                        <RadzenText Text="@($"{SelectKHSX?.DSachCongDoans.FirstOrDefault()?.DSachNVLCongDoans?.FirstOrDefault()?.MaQuanLy.Value?.ToString()} --> {SelectKHSX?.DSachCongDoans.FirstOrDefault()?.DSachNVLCongDoans?.LastOrDefault()?.MaQuanLy.Value?.ToString()}")"
                                                    Style="color: darkred; font-weight: 600; font-size: 16px"></RadzenText>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenStack Orientation="Orientation.Horizontal" Style="height: contain; width: 100%; padding: 10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                                @{
                                    <!--Chua tao phieu xuat kho-->
                                    <RadzenStack Style="height: contain; width: contain; padding: 0px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenAlert Visible="@(PXKofKHSX.PXKID.Value == null)" Text="Chưa tạo phiếu xuất kho NVL cho KHSX" Style="width: contain; height: 100%; font-size: 14px; padding: 2px; padding-left: 10px; padding-right: 10px; margin: 0" AlertStyle="AlertStyle.Warning" AllowClose="false" Variant="Variant.Flat" Size="AlertSize.Small" Shade="Shade.Lighter"></RadzenAlert>
                                    </RadzenStack>
                                    <!--Chua tao phieu xuat kho-->
                                    <RadzenButton Visible="@(PXKofKHSX.PXKID.Value == null)" Click="OnOpenDialogCreatePhieuXuatKho" Icon="upload" Text="Tạo phiếu xuất kho NVL" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                                  Style="height: contain; width: contain; font-size: 14px;" />

                                    <!--Da tao phieu xuat kho/ Da chi dinh vi tri NVL/ Chua hoan thanh xuat kho-->
                                    <RadzenStack Style="height: contain; width: contain; padding: 0px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenAlert Visible="@(PXKofKHSX.PXKID.Value != null && PXKofKHSX.IsChiDinhDuSLXuatKho && !PXKofKHSX.IsPXKDoneXuatKho)" Text="Chưa hoàn thành xuất kho NVL cho KHSX" Style="width: contain; height: 100%; font-size: 14px; padding: 2px; padding-left: 10px; padding-right: 10px; margin: 0" AlertStyle="AlertStyle.Warning" AllowClose="false" Variant="Variant.Flat" Size="AlertSize.Small" Shade="Shade.Lighter"></RadzenAlert>
                                    </RadzenStack>
                                    <!--Da tao phieu xuat kho/ Da chi dinh vi tri NVL/ Chua hoan thanh xuat kho-->
                                    <RadzenButton Visible="@(PXKofKHSX.PXKID.Value != null && PXKofKHSX.IsChiDinhDuSLXuatKho && !PXKofKHSX.IsPXKDoneXuatKho)" Click="NavigateToHandlePhieuXuatKho" Text="@($"Tiến hành xuất kho NVL ({PXKofKHSX.MaPhieuXK.Value?.ToString()})")" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                                  Style="height: contain; width: contain; font-size: 14px;" />

                                    <!--Da tao phieu xuat kho/ Da chi dinh vi tri NVL/ Da hoan thanh xuat kho-->
                                    <RadzenStack Style="height: contain; width: contain; padding: 0px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenAlert Visible="@(PXKofKHSX.PXKID.Value != null && PXKofKHSX.IsChiDinhDuSLXuatKho && PXKofKHSX.IsPXKDoneXuatKho)" Text="Đã xuất kho NVL cho kế hoạch sản xuất" Style="width: contain; height: 100%; font-size: 14px; padding: 2px; padding-left: 10px; padding-right: 10px; margin: 0" AlertStyle="AlertStyle.Success" AllowClose="false" Variant="Variant.Flat" Size="AlertSize.Small" Shade="Shade.Lighter"></RadzenAlert>
                                    </RadzenStack>
                                    <!--Da tao phieu xuat kho/ Da tao phieu xuat kho/ Da hoan thanh xuat kho -->
                                    <RadzenButton Visible="@(PXKofKHSX.PXKID.Value != null && PXKofKHSX.IsChiDinhDuSLXuatKho && PXKofKHSX.IsPXKDoneXuatKho)" Click="@(() => OnOpenDialogXemPhieuXuatKho("Xem phiếu xuất kho NVL"))" Text="Xem phiếu xuất kho NVL" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Primary" Variant="Variant.Filled" Shade="Shade.Lighter"
                                                  Style="height: contain; width: contain; font-size: 14px;" />
                                }
                            </RadzenStack>
                            <!--Danh sach nguyen lieu da chon-->
                            <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; padding: 0px;" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                                <RadzenCard Variant="Variant.Filled" Style="height: contain; width: 100%; padding: 10px;">
                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; padding: 0px; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        <RadzenStack Gap="20px" Style="height: contain; width: 100%; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenText Text="Nguyên vật liệu của kế hoạch sản xuất" Style="color: green; font-weight: 500; font-size: 16px"></RadzenText>
                                        </RadzenStack>
                                        <RadzenStack Gap="20px" Style="height: contain; width: 100%; padding: 10px; padding-top: 0px; padding-bottom: 0px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                            <RadzenText Text="@($"Tổng số NVL: {SelectKHSX?.DSachNVLofKHSXs?.Sum(nvl => (int.TryParse(nvl.DinhMuc.Value?.ToString(), out int dm) ? dm : 0)) ?? 0} (PCS)")" Style="color: black; font-weight: 600; font-size: 16px"></RadzenText>
                                        </RadzenStack>
                                        <RadzenRow Gap="10px" Style="width: 100%; height: contain;">
                                            <RadzenColumn Size="12" SizeMD="12" Style="width: 100%; height: 100%;">
                                                <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style="height: 100%; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                    <RadzenStack Gap="0" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 5px;">
                                                            <RadzenStack Style="width: 100%; height: contain" Gap="0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                <RadzenStack Style="width: 5%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                    <RadzenText Text="#" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                                </RadzenStack>
                                                                <RadzenStack Style="width: 40%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                    <RadzenText Text="Tên vật liệu" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                                </RadzenStack>
                                                                <RadzenStack Style="width: 35%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                    <RadzenText Text="Số lượng lấy" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                                </RadzenStack>
                                                                <RadzenStack Style="width: 20%; height: contain; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                    <RadzenText Text="" Style="font-size: 14px; font-weight: 600; height: contain;"></RadzenText>
                                                                </RadzenStack>
                                                            </RadzenStack>
                                                        </RadzenCard>
                                                    </RadzenStack>

                                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 90%; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                                        @{
                                                            var dsachnvlofkhsx = SelectKHSX?.DSachNVLofKHSXs;
                                                        }
                                                        @if (dsachnvlofkhsx != null)
                                                        {
                                                            @foreach (var nvlofkhsx in dsachnvlofkhsx)
                                                            {
                                                                var ngvatlieu = GetNguyenVatLieu(nvlofkhsx);

                                                                <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 5px; padding-right: 0px; background-color: white">
                                                                    <RadzenStack Style="width: 100%; height: 100%" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                        <RadzenStack Style="width: 5%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenText Text="@((dsachnvlofkhsx.IndexOf(nvlofkhsx) + 1).ToString())" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                                        </RadzenStack>
                                                                        <RadzenStack Style="width: 40%; height: contain; border-left: var(--rz-grid-cell-border); border-right: var(--rz-grid-cell-border); padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenText Text="@ngvatlieu.TenNVL.Value?.ToString()" Style="color: darkblue; font-weight: 600; font-size: 14px"></RadzenText>
                                                                        </RadzenStack>
                                                                        <RadzenStack Style="width: 35%; height: contain; " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenText Text="@($"{nvlofkhsx.DinhMuc?.Value?.ToString()} (pcs)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                                        </RadzenStack>
                                                                        <RadzenStack Style="width: 20%; height: contain; border-left: var(--rz-grid-cell-border);" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                                            <RadzenText Text="Chi tiết" @onclick="@(() => OnOpenDialogXemChitietNVL(ngvatlieu))" Style="font-size: 14px; font-weight: 600; height: contain; color: Highlight; font-style: italic; text-decoration: underline; cursor: pointer"></RadzenText>
                                                                        </RadzenStack>
                                                                    </RadzenStack>
                                                                </RadzenCard>
                                                            }
                                                        }
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenStack>
                                </RadzenCard>
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="4" Style="width: 100%; height: contain; padding-top: 40px">
            <RadzenStack Style="height: 5%; width: 100%; padding-bottom: 5px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Danh sách LOT nguyên vật liệu" Style="color: black; font-style: italic; font-weight: 600; font-size: 16px"></RadzenText>
            </RadzenStack>
            <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 95%; width: 100%; padding: 10px; border-top: var(--rz-grid-cell-border);" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                <!--LOT List-->
                <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 5px;">
                    <RadzenStack Gap="0" Orientation="Orientation.Vertical" Style=" height: 100%; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenStack Gap="0" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; padding-right: 10px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                            <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 5px;">
                                <RadzenStack Style="width: 100%; height: contain" Gap="0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Style="width: 10%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="#" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 60%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Mã quản lý" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                    </RadzenStack>
                                    <RadzenStack Style="width: 30%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenText Text="Số lượng" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenCard>
                        </RadzenStack>

                        <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%; max-height: 500px; overflow-y: scroll" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                            @{
                                var listnvl = SelectKHSX?.DSachCongDoans.FirstOrDefault()?.DSachNVLCongDoans;
                            }
                            @if (listnvl != null)
                            {
                                @foreach (var lot in listnvl)
                                {
                                    <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: 100%; padding: 5px; background-color: white">
                                        <RadzenStack Style="width: 100%; height: contain" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                            <RadzenStack Style="width: 10%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@((SelectKHSX?.DSachCongDoans.FirstOrDefault()?.DSachNVLCongDoans?.IndexOf(lot) + 1).ToString())" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 60%; height: contain; background-color: beige" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@lot.MaQuanLy.Value?.ToString()" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                            </RadzenStack>
                                            <RadzenStack Style="width: 30%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenText Text="@($"{lot.SLGoccuaLOTNVL.Value} (pcs)")" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenCard>
                                }
                            }
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="4" Style="width: 100%; height: contain; padding-top: 40px">
            <RadzenStack Style="height: 5%; width: 100%; padding-bottom: 5px" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                <RadzenText Text="Nguyên công sản xuất" Style="color: black; font-style: italic; font-weight: 600; font-size: 16px"></RadzenText>
            </RadzenStack>
            <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 95%; width: 100%; padding: 10px; border-top: var(--rz-grid-cell-border);" AlignItems="AlignItems.Start" JustifyContent="JustifyContent.Start">
                <RadzenCard Variant="Variant.Filled" Style="height: 100%; width: 100%; padding: 10px;">
                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: 100%; width: 100%; padding: 0px; " AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                        <RadzenStack Visible="@(SelectKHSX?.TileLoi.Value != null)" Gap="20px" Style="height: contain; width: 100%; background-color: var(--rz-success-lighter); padding: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                            <RadzenText Text="Tỉ lệ lỗi cho phép: " Style="color: green; font-weight: 500; font-size: 16px"></RadzenText>
                            <RadzenText Text="@($"{SelectKHSX?.TileLoi.Value?.ToString()} %")" Style="color: darkred; font-weight: 500; font-size: 16px"></RadzenText>
                            <RadzenText Text="~" Style="color: darkred; font-weight: 500; font-size: 16px"></RadzenText>
                            @{
                                int slloikhsx = (int.TryParse(SelectKHSX?.DinhMuc.Value?.ToString(), out int dm) ? dm : 0) - (int.TryParse(SelectKHSX?.SLNVLSanXuat.Value?.ToString(), out int slsx) ? slsx : 0);
                            }
                            <RadzenText Text="@($"{slloikhsx} (pcs)")" Style="color: darkred; font-weight: 500; font-size: 16px"></RadzenText>
                        </RadzenStack>
                        <RadzenRow Gap="10px" Style="width: 100%; height: 80%;">
                            <RadzenColumn Size="12" SizeMD="12" Style="width: 100%; height: 100%;">
                                <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style="height: 100%; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                    <RadzenStack Gap="0" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                        <RadzenCard Variant="Variant.Flat" Style="width: 100%; height: 100%; padding: 5px;">
                                            <RadzenStack Style="width: 100%; height: contain" Gap="0" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                <RadzenStack Style="width: 5%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="#" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                </RadzenStack>
                                                <RadzenStack Style="width: 50%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="Nguyên công" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                </RadzenStack>
                                                <RadzenStack Style="width: 45%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                    <RadzenText Text="SL lỗi cho phép" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenStack>

                                    <RadzenStack Gap="10px" Orientation="Orientation.Vertical" Style=" height: contain; width: 100%;" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Start">
                                        @{
                                            var dsnguyencong = SelectKHSX?.DSachCongDoans;
                                        }
                                        @if (dsnguyencong != null)
                                        {
                                            @foreach (var nguyencong in dsnguyencong)
                                            {
                                                <RadzenCard Variant="Variant.Outlined" Style="width: 100%; height: contain; padding: 5px; padding-right: 0px; background-color: white">
                                                    <RadzenStack Style="width: 100%; height: 100%" Gap="10px" Orientation=Orientation.Horizontal AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                        <RadzenStack Style="width: 5%; height: contain;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                            <RadzenText Text="@((dsnguyencong.IndexOf(nguyencong) + 1).ToString())" Style="color: black; font-weight: 600; font-size: 14px"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 50%; height: contain; border-left: var(--rz-grid-cell-border); border-right: var(--rz-grid-cell-border); padding-left: 10px; padding-right: 10px" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                            <RadzenText Text="@nguyencong.TenCongDoan.Value?.ToString()" Style="color: darkblue; font-weight: 600; font-size: 14px"></RadzenText>
                                                        </RadzenStack>
                                                        <RadzenStack Style="width: 45%; height: contain; " Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center">
                                                            <RadzenText Text="@($"{nguyencong.SoluongNG?.Value?.ToString()} (pcs)")" Style="font-size: 16px; font-weight: 600; height: contain; color: rgba(58,71,77)"></RadzenText>
                                                        </RadzenStack>
                                                    </RadzenStack>
                                                </RadzenCard>
                                            }
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenCard>
            </RadzenStack>
        </RadzenColumn>
    </RadzenRow>
    <RadzenStack Visible="@(IsNotDialog == false)" Gap="10px" Style="width: 100%; padding-top: 10px;" Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.End">
        <RadzenButton Style="width: contain; color: white; background-color: darkred" Icon="close" Text="Thoát" Size="ButtonSize.Small" Variant="Variant.Flat" Click="@(() => DialogService.Close())" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter]
    public KHSX? SelectKHSX { get; set; }

    [Parameter]
    public bool IsNotDialog { get; set; } = false;

    private PhieuXuatKho PXKofKHSX = new();

    protected async override Task OnParametersSetAsync()
    {
        if (PXKofKHSX.PXKID.Value == null)
        {
            PXKofKHSX = SQLServerServices.GetPhieuXuatKhoByID(SelectKHSX?.PXKID.Value);
        }

        await base.OnParametersSetAsync();
    }

    private void ReloadCurrentKHSX(object? currentKHSXid)
    {
        SelectKHSX = SQLServerServices.GetKHSXbyID(currentKHSXid);

        if (SelectKHSX?.KHSXID.Value != null)
        {
            // Kiem tra trang thai lay NVL cua KHSX
            // Load thong tin phieu xuat kho cua KHSX
            PXKofKHSX = SQLServerServices.GetPhieuXuatKhoByID(SelectKHSX.PXKID.Value);
        }
        else SelectKHSX = new();
    }

    private async Task OnOpenDialogXemChitietNVL(NguyenVatLieu nguyenVatLieu)
    {
        await DialogService.OpenAsync<DialogDetailsNguyenVatLieu>(null, new Dictionary<string, object>() { { "NgVLieu", nguyenVatLieu } },
        new DialogOptions() { ShowTitle = false, Width = "50%", Height = "contain", Resizable = false, Draggable = false, ShowClose = false, Style = "background-color: while; border-radius: 10px; padding: 0px" });
    }

    private NguyenVatLieu GetNguyenVatLieu(NVLofKHSX nVLofKHSX)
    {
        int nvlid = int.TryParse(nVLofKHSX.NVLID.Value?.ToString(), out int id) ? id : 0;

        var nguyenvatlieu = SQLServerServices.GetNguyenVatLieuByID(nvlid);

        return nguyenvatlieu;
    }

    // Tao phieu xuat kho dialog
    private async Task OnOpenDialogCreatePhieuXuatKho()
    {
        if (SelectKHSX?.DSachNVLofKHSXs.Count > 0)
        {
            await DialogService.OpenAsync<Manager_NVL.XuatKho.DialogCreate_PhieuXuatKho>(null, new Dictionary<string, object>() { { "DSNVLofKHSX", SelectKHSX.DSachNVLofKHSXs }, { "CreatedWithKHSX", true }, { "KHSX", SelectKHSX } },
            new DialogOptions() { ShowTitle = false, Width = "85%", Height = "100%", Resizable = true, Draggable = true, ShowClose = false, Style = "background-color: while; border-radius: 10px; padding: 0px;" });

            ReloadCurrentKHSX(SelectKHSX.KHSXID.Value);
        }
    }

    // Xem phieu xuat kho dialog
    private async Task OnOpenDialogXemPhieuXuatKho(string tilte)
    {
        if (SelectKHSX?.DSachNVLofKHSXs.Count > 0)
        {
            await DialogService.OpenAsync<Manager_NVL.XuatKho.PhieuXuatKhoDetails>(tilte, new Dictionary<string, object>() { { "PXK", PXKofKHSX } },
            new DialogOptions() { ShowTitle = true, Width = "70%", Height = "contain", Resizable = true, Draggable = true, ShowClose = true, Style = "background-color: while; border-radius: 10px; padding: 0px;" });
        }
    }

    // Navigate to handlephieuxuatkho page
    private void NavigateToHandlePhieuXuatKho()
    {
        _ = int.TryParse(SelectKHSX?.KHSXID.Value?.ToString(), out int khsxid) ? khsxid : 0;

        Common.SelectedPXKID = SelectKHSX?.PXKID.Value;

        NavigationManager.NavigateTo($"khomanagement?tabindxex={3}&khsxid={khsxid}");
    }
}
