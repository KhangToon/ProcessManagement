@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using ProcessManagement.Models
@using ProcessManagement.Services.Authorization
@using ProcessManagement.Models.Authorization
@using System.Security.Claims
@using Radzen
@using Radzen.Blazor

@inject ButtonRoleService ButtonRoleService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject AdminPermissionModeService AdminPermissionModeService

<AuthorizedAction ButtonId="@ButtonId" RequiredPermission="@RequiredPermission" RequiredRole="@RequiredRole">
    <div @oncontextmenu="@(async (e) => await OnRightClick(e))" 
         @oncontextmenu:preventDefault="@isAdjustMode"
         style="@(isAdjustMode ? "position: relative;" : "")">
        @if (isAdjustMode)
        {
            <RadzenBadge Text="ðŸ”§" 
                        Style="position: absolute; top: -5px; right: -5px; z-index: 1000; cursor: pointer; background: #ff9800; padding: 2px 5px; border-radius: 50%; font-size: 10px;"
                        @onclick="@(async () => await OpenSetRoleDialog())" />
        }
        @ChildContent
    </div>
</AuthorizedAction>

@code {
    [Parameter] public string? ButtonId { get; set; }
    [Parameter] public string? RequiredPermission { get; set; }
    [Parameter] public string? RequiredRole { get; set; }
    [Parameter] public string? ButtonText { get; set; } // Text hiá»ƒn thá»‹ cá»§a button (Ä‘á»ƒ admin dá»… nháº­n biáº¿t)
    [Parameter] public RenderFragment? ChildContent { get; set; }
    
    [CascadingParameter] private Task<AuthenticationState>? AuthenticationStateTask { get; set; }
    
    private bool isAdminUser = false;
    private bool isAdjustMode => isAdminUser && AdminPermissionModeService.IsEnabled;

    private ClaimsPrincipal? currentUser;

    protected override async Task OnInitializedAsync()
    {
        if (AuthenticationStateTask != null)
        {
            var authState = await AuthenticationStateTask;
            currentUser = authState?.User;
            isAdminUser = currentUser != null && currentUser.IsInRole("Admin");
        }

        AdminPermissionModeService.OnModeChanged += OnAdminModeChanged;

        await base.OnInitializedAsync();
    }

    private void OnAdminModeChanged()
    {
        // Chá»‰ cáº§n refresh UI khi cháº¿ Ä‘á»™ thay Ä‘á»•i
        InvokeAsync(StateHasChanged);
    }

    private async Task OnRightClick(Microsoft.AspNetCore.Components.Web.MouseEventArgs e)
    {
        if (isAdjustMode && !string.IsNullOrEmpty(ButtonId))
        {
            await OpenSetRoleDialog();
        }
    }

    private async Task OpenSetRoleDialog()
    {
        if (string.IsNullOrEmpty(ButtonId))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cáº£nh bÃ¡o", "ButtonId khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng");
            return;
        }

        var currentPath = NavigationManager.Uri;
        var pagePath = new Uri(currentPath).PathAndQuery;
        var displayText = !string.IsNullOrEmpty(ButtonText) ? ButtonText : ButtonId ?? "Unknown Button";

        await DialogService.OpenAsync<SetButtonRoleDialog>("GÃ¡n Role cho Button",
            new Dictionary<string, object> 
            { 
                { "ButtonId", ButtonId },
                { "PagePath", pagePath },
                { "ButtonText", displayText }
            },
            new DialogOptions { Width = "500px", Height = "auto", Resizable = true, Draggable = true });
    }

    public void Dispose()
    {
        AdminPermissionModeService.OnModeChanged -= OnAdminModeChanged;
    }
}

